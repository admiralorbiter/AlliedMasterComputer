{% extends "base.html" %}

{% block title %}Music Library{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/music.css') }}">
{% endblock %}

{% block content %}
<div class="music-container">
    <div class="music-header">
        <h1><i class="fas fa-music"></i> Music Library</h1>
        <div class="header-actions">
            <div id="bulkActions" class="bulk-actions" style="display: none;">
                <span id="selectedCount" class="selected-count">0 selected</span>
                <button type="button" class="btn btn-success" id="bulkAddToPlaylistBtn">
                    <i class="fas fa-plus"></i> Add to Playlist
                </button>
            </div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="fas fa-upload"></i> Import CSV
            </button>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="music-filters">
        <form method="GET" action="{{ url_for('music_library') }}" class="row g-3" id="searchForm">
            {% if sort_by %}<input type="hidden" name="sort_by" value="{{ sort_by }}">{% endif %}
            {% if sort_order %}<input type="hidden" name="sort_order" value="{{ sort_order }}">{% endif %}
            <div class="col-md-4">
                <input type="text" 
                       class="form-control" 
                       name="q" 
                       placeholder="Search tracks, artists, albums..." 
                       value="{{ query }}">
            </div>
            <div class="col-md-2">
                <select class="form-select" name="explicit">
                    <option value="">All Content</option>
                    <option value="false" {% if explicit_filter == 'false' %}selected{% endif %}>Clean Only</option>
                    <option value="true" {% if explicit_filter == 'true' %}selected{% endif %}>Explicit Only</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" 
                       class="form-control" 
                       name="min_popularity" 
                       placeholder="Min Popularity" 
                       value="{{ min_popularity if min_popularity else '' }}"
                       min="0" 
                       max="100">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-light w-100" style="font-weight: 600;">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('music_library') }}" class="btn btn-light w-100" style="font-weight: 600;">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Songs Table -->
    {% if songs and songs.items %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAllCheckbox" title="Select All">
                    </th>
                    <th class="sortable {% if sort_by == 'track_name' %}sort-{{ sort_order }}{% endif %}" data-sort="track_name">
                        Track Name
                        <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable {% if sort_by == 'artist_names' %}sort-{{ sort_order }}{% endif %}" data-sort="artist_names">
                        Artist
                        <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable {% if sort_by == 'album_name' %}sort-{{ sort_order }}{% endif %}" data-sort="album_name">
                        Album
                        <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable {% if sort_by == 'release_date' %}sort-{{ sort_order }}{% endif %}" data-sort="release_date">
                        Release Date
                        <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable {% if sort_by == 'popularity' %}sort-{{ sort_order }}{% endif %}" data-sort="popularity">
                        Popularity
                        <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable {% if sort_by == 'explicit' %}sort-{{ sort_order }}{% endif %}" data-sort="explicit">
                        Explicit
                        <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable {% if sort_by == 'tempo' %}sort-{{ sort_order }}{% endif %}" data-sort="tempo">
                        Tempo
                        <span class="sort-indicator"></span>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for song in songs.items %}
                <tr class="song-row" data-track-uri="{{ song.track_uri }}">
                    <td onclick="event.stopPropagation();">
                        <input type="checkbox" class="song-checkbox" value="{{ song.track_uri }}">
                    </td>
                    <td style="cursor: pointer;">
                        <strong>{{ song.track_name or '—' }}</strong>
                    </td>
                    <td style="cursor: pointer;">
                        <span style="color: #6c757d;">{{ song.artist_names or '—' }}</span>
                    </td>
                    <td style="cursor: pointer;">
                        <span style="color: #6c757d; font-size: 0.9rem;">{{ song.album_name or '—' }}</span>
                    </td>
                    <td style="cursor: pointer;">
                        <span style="color: #6c757d;">{{ song.release_date or '—' }}</span>
                    </td>
                    <td style="cursor: pointer;">
                        {% if song.popularity is not none %}
                            <span class="badge bg-info">{{ song.popularity }}</span>
                        {% else %}
                            <span style="color: #adb5bd;">—</span>
                        {% endif %}
                    </td>
                    <td style="cursor: pointer;">
                        {% if song.explicit %}
                            <span class="badge bg-danger">Explicit</span>
                        {% else %}
                            <span class="badge bg-success">Clean</span>
                        {% endif %}
                    </td>
                    <td style="cursor: pointer;">
                        {% if song.tempo %}
                            <span style="font-weight: 600; color: #6c5ce7;">{{ "%.1f"|format(song.tempo) }} <small style="color: #6c757d; font-weight: normal;">BPM</small></span>
                        {% else %}
                            <span style="color: #adb5bd;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if songs.pages > 1 %}
    <nav aria-label="Music library pagination">
        <ul class="pagination justify-content-center">
            {% if songs.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('music_library', page=songs.prev_num, q=query, explicit=explicit_filter, min_popularity=min_popularity, sort_by=sort_by, sort_order=sort_order) }}">Previous</a>
                </li>
            {% endif %}
            
            {% for page_num in songs.iter_pages() %}
                {% if page_num %}
                    {% if page_num != songs.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('music_library', page=page_num, q=query, explicit=explicit_filter, min_popularity=min_popularity, sort_by=sort_by, sort_order=sort_order) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if songs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('music_library', page=songs.next_num, q=query, explicit=explicit_filter, min_popularity=min_popularity, sort_by=sort_by, sort_order=sort_order) }}">Next</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <i class="fas fa-music fa-3x"></i>
        <h3>No Songs Yet</h3>
        <p>Import your first CSV file to get started.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="fas fa-upload"></i> Import CSV
        </button>
    </div>
    {% endif %}
</div>

<!-- Song Details Modal -->
<div class="modal fade" id="songDetailsModal" tabindex="-1" aria-labelledby="songDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="songDetailsModalLabel">
                    <i class="fas fa-music me-2"></i>Song Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="songDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading song details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="fas fa-upload me-2"></i>Import CSV File
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                        <div class="form-text">Upload a CSV file with music track data.</div>
                    </div>
                    
                    <div id="importProgress" style="display: none;">
                        <div class="mb-2">
                            <strong>Importing...</strong>
                            <span id="importStatusText" class="text-muted"></span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 id="importProgressBar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <div class="mt-2 small text-muted" id="importStats"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="importCloseBtn">Close</button>
                <button type="button" class="btn btn-primary" id="importSubmitBtn">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add to Playlist Modal -->
<div class="modal fade" id="bulkAddToPlaylistModal" tabindex="-1" aria-labelledby="bulkAddToPlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkAddToPlaylistModalLabel">
                    <i class="fas fa-list me-2"></i>Add Songs to Playlist
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Select a playlist to add <span id="bulkAddCount">0</span> selected song(s):</p>
                <div id="bulkPlaylistOptions">
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <hr>
                <a href="#" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#createPlaylistFromBulkModal" data-bs-dismiss="modal">
                    <i class="fas fa-plus"></i> Create New Playlist
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Create Playlist from Bulk Modal -->
<div class="modal fade" id="createPlaylistFromBulkModal" tabindex="-1" aria-labelledby="createPlaylistFromBulkModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPlaylistFromBulkModalLabel">
                    <i class="fas fa-plus me-2"></i>Create New Playlist
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPlaylistFromBulkForm">
                    <div class="mb-3">
                        <label for="createPlaylistFromBulkName" class="form-label">Playlist Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createPlaylistFromBulkName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="createPlaylistFromBulkDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="createPlaylistFromBulkDescription" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createPlaylistFromBulkSubmit">
                    <i class="fas fa-plus"></i> Create & Add Songs
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/music-library.js') }}"></script>
{% endblock %}

