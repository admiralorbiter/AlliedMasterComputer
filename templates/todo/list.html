{% extends "base.html" %}

{% block title %}To Do{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/todo.css') }}">
{% endblock %}

{% block content %}
<div class="todo-container">
    <div class="todo-header">
        <h1><i class="fas fa-tasks"></i> To Do</h1>
    </div>

    <div class="todo-main-layout row g-4">
        <!-- Main Content: Todos -->
        <div class="todo-main-content col-lg-8 col-xl-9">
            <!-- Add Todo Form -->
            <div class="todo-form-container">
        <form method="POST" action="{{ url_for('todo_list') }}" class="todo-form">
            {{ form.hidden_tag() }}
            <div class="row w-100">
                <div class="col-md-7">
                    {{ form.description.label(class="form-label") }}
                    {{ form.description(class="form-control") }}
                    {% if form.description.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.description.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {{ form.due_date.label(class="form-label") }}
                    <div class="position-relative">
                        {{ form.due_date(class="form-control") }}
                        <i class="fas fa-calendar-alt position-absolute" style="right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #adb5bd; font-size: 0.85rem;"></i>
                    </div>
                    {% if form.due_date.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.due_date.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>
            </div>

            <!-- Todo List -->
            <div class="todo-list-container">
        {% if todos %}
            <ul class="todo-list">
                {% for todo in todos %}
                <li class="todo-item {% if todo.completed %}completed{% endif %}" data-todo-id="{{ todo.id }}">
                    <div class="todo-checkbox-container">
                        <input type="checkbox" 
                               class="todo-checkbox" 
                               {% if todo.completed %}checked{% endif %}
                               data-todo-id="{{ todo.id }}"
                               aria-label="Toggle todo completion">
                    </div>
                    <div class="todo-content">
                        <div class="todo-description {% if todo.completed %}text-muted text-decoration-line-through{% endif %}">
                            {{ todo.description }}
                        </div>
                        {% if todo.due_date %}
                        <div class="todo-due-date">
                            <i class="fas fa-calendar"></i> Due: {{ todo.due_date.strftime('%Y-%m-%d') }}
                        </div>
                        {% endif %}
                        <div class="todo-meta">
                            <small class="text-muted">Created: {{ todo.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        
                        <!-- Subtasks Section -->
                        <div class="subtasks-container" data-todo-id="{{ todo.id }}">
                            <div class="subtasks-list">
                                {% if todo.subtasks_list %}
                                    {% for subtask in todo.subtasks_list %}
                                    <div class="subtask-item {% if subtask.completed %}completed{% endif %}" data-subtask-id="{{ subtask.id }}">
                                        <input type="checkbox" 
                                               class="subtask-checkbox" 
                                               {% if subtask.completed %}checked{% endif %}
                                               data-todo-id="{{ todo.id }}"
                                               data-subtask-id="{{ subtask.id }}"
                                               aria-label="Toggle subtask completion">
                                        <span class="subtask-description {% if subtask.completed %}text-muted text-decoration-line-through{% endif %}">
                                            {{ subtask.description }}
                                        </span>
                                        <button type="button" 
                                                class="btn btn-sm btn-link text-danger subtask-delete-btn p-0 ms-2" 
                                                data-todo-id="{{ todo.id }}"
                                                data-subtask-id="{{ subtask.id }}"
                                                aria-label="Delete subtask"
                                                title="Delete subtask">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="subtask-add-form">
                                <input type="text" 
                                       class="subtask-input form-control" 
                                       placeholder="Add a subtask..." 
                                       data-todo-id="{{ todo.id }}">
                                <button type="button" 
                                        class="subtask-add-btn" 
                                        data-todo-id="{{ todo.id }}"
                                        title="Add subtask"
                                        aria-label="Add subtask">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="todo-actions">
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger todo-delete-btn" 
                                data-todo-id="{{ todo.id }}"
                                aria-label="Delete todo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-clipboard-list fa-3x"></i>
                <h3>No Todos Yet</h3>
                <p>Add your first todo using the form above.</p>
            </div>
        {% endif %}
            </div>
        </div>
        
        <!-- Sidebar: Upcoming Events -->
        <div class="events-sidebar col-lg-4 col-xl-3">
            <div class="events-header">
                <h2><i class="fas fa-calendar-alt"></i> Upcoming Events</h2>
            </div>
            
            <!-- Add Event Form -->
            <div class="event-form-container">
                <form class="event-form" id="eventForm">
                    <input type="text" 
                           class="form-control event-description-input" 
                           placeholder="Event description" 
                           id="eventDescription"
                           required>
                    <input type="date" 
                           class="form-control event-date-input" 
                           id="eventDate"
                           required>
                    <textarea class="form-control event-notes-input" 
                              placeholder="Notes (optional)" 
                              id="eventNotes"
                              rows="2"></textarea>
                    <button type="submit" class="event-add-btn">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </form>
            </div>
            
            <!-- Events List -->
            <div class="events-list-container">
                {% if events %}
                    <div class="events-list">
                        {% for event in events %}
                        <div class="event-item" data-event-id="{{ event.id }}">
                            <div class="event-content">
                                <div class="event-description-display">
                                    <strong>{{ event.description }}</strong>
                                </div>
                                <div class="event-date-display">
                                    <i class="fas fa-calendar"></i> {{ event.event_date.strftime('%Y-%m-%d') }}
                                </div>
                                {% if event.notes %}
                                <div class="event-notes-display">
                                    {{ event.notes }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="event-actions">
                                <button type="button" 
                                        class="btn btn-sm btn-link event-edit-btn" 
                                        data-event-id="{{ event.id }}"
                                        title="Edit event">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-link text-danger event-delete-btn" 
                                        data-event-id="{{ event.id }}"
                                        title="Delete event">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="events-empty-state">
                        <p class="text-muted">No upcoming events. Add one above!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token from meta tag or form
    function getCSRFToken() {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
        // Fallback: get from form hidden field
        const form = document.querySelector('.todo-form');
        if (form) {
            const csrfInput = form.querySelector('input[name="csrf_token"]');
            if (csrfInput) {
                return csrfInput.value;
            }
        }
        return null;
    }
    
    // Handle checkbox toggle
    document.querySelectorAll('.todo-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const todoId = this.dataset.todoId;
            const todoItem = this.closest('.todo-item');
            const description = todoItem.querySelector('.todo-description');
            
            // Optimistic UI update
            if (this.checked) {
                todoItem.classList.add('completed');
                description.classList.add('text-muted', 'text-decoration-line-through');
            } else {
                todoItem.classList.remove('completed');
                description.classList.remove('text-muted', 'text-decoration-line-through');
            }
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/toggle`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert optimistic update on error
                    this.checked = !this.checked;
                    if (this.checked) {
                        todoItem.classList.add('completed');
                        description.classList.add('text-muted', 'text-decoration-line-through');
                    } else {
                        todoItem.classList.remove('completed');
                        description.classList.remove('text-muted', 'text-decoration-line-through');
                    }
                    alert('Error updating todo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                this.checked = !this.checked;
                if (this.checked) {
                    todoItem.classList.add('completed');
                    description.classList.add('text-muted', 'text-decoration-line-through');
                } else {
                    todoItem.classList.remove('completed');
                    description.classList.remove('text-muted', 'text-decoration-line-through');
                }
                console.error('Error:', error);
                alert('Error updating todo. Please try again.');
            });
        });
    });
    
    // Handle delete button
    document.querySelectorAll('.todo-delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const todoId = this.dataset.todoId;
            const todoItem = this.closest('.todo-item');
            
            if (!confirm('Are you sure you want to delete this todo?')) {
                return;
            }
            
            // Optimistic UI update
            todoItem.style.opacity = '0.5';
            todoItem.style.pointerEvents = 'none';
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/delete`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from DOM
                    todoItem.style.transition = 'opacity 0.3s ease-out';
                    todoItem.style.opacity = '0';
                    setTimeout(function() {
                        todoItem.remove();
                        
                        // Check if list is empty and show empty state
                        const todoList = document.querySelector('.todo-list');
                        if (todoList && todoList.children.length === 0) {
                            location.reload();
                        }
                    }, 300);
                } else {
                    // Revert optimistic update on error
                    todoItem.style.opacity = '1';
                    todoItem.style.pointerEvents = 'auto';
                    alert('Error deleting todo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                todoItem.style.opacity = '1';
                todoItem.style.pointerEvents = 'auto';
                console.error('Error:', error);
                alert('Error deleting todo. Please try again.');
            });
        });
    });
    
    // Handle subtask checkbox toggle
    document.querySelectorAll('.subtask-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const todoId = this.dataset.todoId;
            const subtaskId = this.dataset.subtaskId;
            const subtaskItem = this.closest('.subtask-item');
            const description = subtaskItem.querySelector('.subtask-description');
            
            // Optimistic UI update
            if (this.checked) {
                subtaskItem.classList.add('completed');
                description.classList.add('text-muted', 'text-decoration-line-through');
            } else {
                subtaskItem.classList.remove('completed');
                description.classList.remove('text-muted', 'text-decoration-line-through');
            }
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/subtasks/${subtaskId}/toggle`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert optimistic update on error
                    this.checked = !this.checked;
                    if (this.checked) {
                        subtaskItem.classList.add('completed');
                        description.classList.add('text-muted', 'text-decoration-line-through');
                    } else {
                        subtaskItem.classList.remove('completed');
                        description.classList.remove('text-muted', 'text-decoration-line-through');
                    }
                    alert('Error updating subtask: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                this.checked = !this.checked;
                if (this.checked) {
                    subtaskItem.classList.add('completed');
                    description.classList.add('text-muted', 'text-decoration-line-through');
                } else {
                    subtaskItem.classList.remove('completed');
                    description.classList.remove('text-muted', 'text-decoration-line-through');
                }
                console.error('Error:', error);
                alert('Error updating subtask. Please try again.');
            });
        });
    });
    
    // Handle subtask delete button
    document.querySelectorAll('.subtask-delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const todoId = this.dataset.todoId;
            const subtaskId = this.dataset.subtaskId;
            const subtaskItem = this.closest('.subtask-item');
            
            // Optimistic UI update
            subtaskItem.style.opacity = '0.5';
            subtaskItem.style.pointerEvents = 'none';
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/subtasks/${subtaskId}/delete`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from DOM
                    subtaskItem.style.transition = 'opacity 0.3s ease-out';
                    subtaskItem.style.opacity = '0';
                    setTimeout(function() {
                        subtaskItem.remove();
                    }, 300);
                } else {
                    // Revert optimistic update on error
                    subtaskItem.style.opacity = '1';
                    subtaskItem.style.pointerEvents = 'auto';
                    alert('Error deleting subtask: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                subtaskItem.style.opacity = '1';
                subtaskItem.style.pointerEvents = 'auto';
                console.error('Error:', error);
                alert('Error deleting subtask. Please try again.');
            });
        });
    });
    
    // Handle subtask input - add on Enter key or button click
    document.querySelectorAll('.subtask-input').forEach(function(input) {
        const addSubtask = function() {
            const todoId = input.dataset.todoId;
            const description = input.value.trim();
            
            if (!description) {
                return;
            }
            
            // Clear input
            input.value = '';
            input.disabled = true;
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/subtasks/create`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ description: description })
            })
            .then(response => response.json())
            .then(data => {
                input.disabled = false;
                if (data.success && data.subtask) {
                    // Add subtask to DOM
                    const subtasksList = input.closest('.subtasks-container').querySelector('.subtasks-list');
                    const subtaskHtml = `
                        <div class="subtask-item" data-subtask-id="${data.subtask.id}">
                            <input type="checkbox" 
                                   class="subtask-checkbox" 
                                   data-todo-id="${todoId}"
                                   data-subtask-id="${data.subtask.id}"
                                   aria-label="Toggle subtask completion">
                            <span class="subtask-description">
                                ${escapeHtml(data.subtask.description)}
                            </span>
                            <button type="button" 
                                    class="btn btn-sm btn-link text-danger subtask-delete-btn p-0 ms-2" 
                                    data-todo-id="${todoId}"
                                    data-subtask-id="${data.subtask.id}"
                                    aria-label="Delete subtask"
                                    title="Delete subtask">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    subtasksList.insertAdjacentHTML('beforeend', subtaskHtml);
                    
                    // Re-attach event listeners to new elements
                    const newCheckbox = subtasksList.querySelector(`.subtask-checkbox[data-subtask-id="${data.subtask.id}"]`);
                    const newDeleteBtn = subtasksList.querySelector(`.subtask-delete-btn[data-subtask-id="${data.subtask.id}"]`);
                    
                    if (newCheckbox) {
                        newCheckbox.addEventListener('change', function() {
                            const todoId = this.dataset.todoId;
                            const subtaskId = this.dataset.subtaskId;
                            const subtaskItem = this.closest('.subtask-item');
                            const description = subtaskItem.querySelector('.subtask-description');
                            
                            if (this.checked) {
                                subtaskItem.classList.add('completed');
                                description.classList.add('text-muted', 'text-decoration-line-through');
                            } else {
                                subtaskItem.classList.remove('completed');
                                description.classList.remove('text-muted', 'text-decoration-line-through');
                            }
                            
                            const headers = {
                                'Content-Type': 'application/json',
                            };
                            const csrfToken = getCSRFToken();
                            if (csrfToken) {
                                headers['X-CSRFToken'] = csrfToken;
                            }
                            
                            fetch(`/todos/${todoId}/subtasks/${subtaskId}/toggle`, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify({})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (!data.success) {
                                    this.checked = !this.checked;
                                    if (this.checked) {
                                        subtaskItem.classList.add('completed');
                                        description.classList.add('text-muted', 'text-decoration-line-through');
                                    } else {
                                        subtaskItem.classList.remove('completed');
                                        description.classList.remove('text-muted', 'text-decoration-line-through');
                                    }
                                }
                            });
                        });
                    }
                    
                    if (newDeleteBtn) {
                        newDeleteBtn.addEventListener('click', function() {
                            const todoId = this.dataset.todoId;
                            const subtaskId = this.dataset.subtaskId;
                            const subtaskItem = this.closest('.subtask-item');
                            
                            subtaskItem.style.opacity = '0.5';
                            subtaskItem.style.pointerEvents = 'none';
                            
                            const headers = {
                                'Content-Type': 'application/json',
                            };
                            const csrfToken = getCSRFToken();
                            if (csrfToken) {
                                headers['X-CSRFToken'] = csrfToken;
                            }
                            
                            fetch(`/todos/${todoId}/subtasks/${subtaskId}/delete`, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify({})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    subtaskItem.style.transition = 'opacity 0.3s ease-out';
                                    subtaskItem.style.opacity = '0';
                                    setTimeout(function() {
                                        subtaskItem.remove();
                                    }, 300);
                                } else {
                                    subtaskItem.style.opacity = '1';
                                    subtaskItem.style.pointerEvents = 'auto';
                                }
                            });
                        });
                    }
                } else {
                    alert('Error creating subtask: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                input.disabled = false;
                console.error('Error:', error);
                alert('Error creating subtask. Please try again.');
            });
        };
        
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSubtask();
            }
        });
        
        const addBtn = input.closest('.subtask-add-form').querySelector('.subtask-add-btn');
        if (addBtn) {
            addBtn.addEventListener('click', addSubtask);
        }
    });
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Handle event form submission
    const eventForm = document.getElementById('eventForm');
    if (eventForm) {
        eventForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const description = document.getElementById('eventDescription').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const notes = document.getElementById('eventNotes').value.trim();
            
            if (!description || !eventDate) {
                alert('Please fill in description and date');
                return;
            }
            
            // Disable form
            const submitBtn = eventForm.querySelector('.event-add-btn');
            submitBtn.disabled = true;
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch('/events/create', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    description: description,
                    event_date: eventDate,
                    notes: notes || null
                })
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                if (data.success && data.event) {
                    // Reset form
                    eventForm.reset();
                    
                    // Add event to DOM
                    const eventsList = document.querySelector('.events-list');
                    const emptyState = document.querySelector('.events-empty-state');
                    
                    if (emptyState) {
                        emptyState.remove();
                    }
                    
                    if (!eventsList) {
                        const container = document.querySelector('.events-list-container');
                        const newList = document.createElement('div');
                        newList.className = 'events-list';
                        container.appendChild(newList);
                    }
                    
                    const eventsListContainer = document.querySelector('.events-list') || document.createElement('div');
                    if (!eventsListContainer.classList.contains('events-list')) {
                        eventsListContainer.className = 'events-list';
                        document.querySelector('.events-list-container').appendChild(eventsListContainer);
                    }
                    
                    const eventHtml = `
                        <div class="event-item" data-event-id="${data.event.id}">
                            <div class="event-content">
                                <div class="event-description-display">
                                    <strong>${escapeHtml(data.event.description)}</strong>
                                </div>
                                <div class="event-date-display">
                                    <i class="fas fa-calendar"></i> ${data.event.event_date}
                                </div>
                                ${data.event.notes ? `<div class="event-notes-display">${escapeHtml(data.event.notes)}</div>` : ''}
                            </div>
                            <div class="event-actions">
                                <button type="button" 
                                        class="btn btn-sm btn-link event-edit-btn" 
                                        data-event-id="${data.event.id}"
                                        title="Edit event">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-link text-danger event-delete-btn" 
                                        data-event-id="${data.event.id}"
                                        title="Delete event">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    eventsListContainer.insertAdjacentHTML('beforeend', eventHtml);
                    
                    // Re-attach event listeners
                    attachEventListeners();
                } else {
                    alert('Error creating event: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                console.error('Error:', error);
                alert('Error creating event. Please try again.');
            });
        });
    }
    
    // Function to attach event listeners
    function attachEventListeners() {
        // Handle event delete
        document.querySelectorAll('.event-delete-btn').forEach(function(button) {
            if (button.dataset.listenerAttached) return;
            button.dataset.listenerAttached = 'true';
            
            button.addEventListener('click', function() {
                const eventId = this.dataset.eventId;
                const eventItem = this.closest('.event-item');
                
                if (!confirm('Are you sure you want to delete this event?')) {
                    return;
                }
                
                eventItem.style.opacity = '0.5';
                eventItem.style.pointerEvents = 'none';
                
                const headers = {
                    'Content-Type': 'application/json',
                };
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }
                
                fetch(`/events/${eventId}/delete`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        eventItem.style.transition = 'opacity 0.3s ease-out';
                        eventItem.style.opacity = '0';
                        setTimeout(function() {
                            eventItem.remove();
                            const eventsList = document.querySelector('.events-list');
                            if (eventsList && eventsList.children.length === 0) {
                                const container = document.querySelector('.events-list-container');
                                const emptyState = document.createElement('div');
                                emptyState.className = 'events-empty-state';
                                emptyState.innerHTML = '<p class="text-muted">No upcoming events. Add one above!</p>';
                                container.appendChild(emptyState);
                            }
                        }, 300);
                    } else {
                        eventItem.style.opacity = '1';
                        eventItem.style.pointerEvents = 'auto';
                        alert('Error deleting event: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    eventItem.style.opacity = '1';
                    eventItem.style.pointerEvents = 'auto';
                    console.error('Error:', error);
                    alert('Error deleting event. Please try again.');
                });
            });
        });
        
        // Handle event edit
        document.querySelectorAll('.event-edit-btn').forEach(function(button) {
            if (button.dataset.listenerAttached) return;
            button.dataset.listenerAttached = 'true';
            
            button.addEventListener('click', function() {
                const eventId = this.dataset.eventId;
                const eventItem = this.closest('.event-item');
                const descriptionEl = eventItem.querySelector('.event-description-display strong');
                const dateEl = eventItem.querySelector('.event-date-display');
                const notesEl = eventItem.querySelector('.event-notes-display');
                
                const currentDescription = descriptionEl.textContent.trim();
                const currentDate = dateEl.textContent.match(/\d{4}-\d{2}-\d{2}/)?.[0] || '';
                const currentNotes = notesEl ? notesEl.textContent.trim() : '';
                
                // Create edit form
                const editForm = document.createElement('form');
                editForm.className = 'event-edit-form';
                editForm.innerHTML = `
                    <input type="text" 
                           class="form-control event-edit-description" 
                           value="${escapeHtml(currentDescription)}" 
                           required>
                    <input type="date" 
                           class="form-control event-edit-date" 
                           value="${currentDate}" 
                           required>
                    <textarea class="form-control event-edit-notes" 
                              rows="2">${escapeHtml(currentNotes)}</textarea>
                    <div class="event-edit-actions">
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary event-cancel-edit">Cancel</button>
                    </div>
                `;
                
                const originalContent = eventItem.querySelector('.event-content').innerHTML;
                const originalActions = eventItem.querySelector('.event-actions').innerHTML;
                
                eventItem.querySelector('.event-content').innerHTML = '';
                eventItem.querySelector('.event-content').appendChild(editForm);
                eventItem.querySelector('.event-actions').style.display = 'none';
                
                // Handle cancel
                editForm.querySelector('.event-cancel-edit').addEventListener('click', function() {
                    eventItem.querySelector('.event-content').innerHTML = originalContent;
                    eventItem.querySelector('.event-actions').innerHTML = originalActions;
                    eventItem.querySelector('.event-actions').style.display = '';
                    attachEventListeners();
                });
                
                // Handle submit
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newDescription = editForm.querySelector('.event-edit-description').value.trim();
                    const newDate = editForm.querySelector('.event-edit-date').value;
                    const newNotes = editForm.querySelector('.event-edit-notes').value.trim();
                    
                    if (!newDescription || !newDate) {
                        alert('Please fill in description and date');
                        return;
                    }
                    
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    const csrfToken = getCSRFToken();
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }
                    
                    fetch(`/events/${eventId}/update`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            description: newDescription,
                            event_date: newDate,
                            notes: newNotes || null
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.event) {
                            // Update DOM
                            eventItem.querySelector('.event-content').innerHTML = `
                                <div class="event-description-display">
                                    <strong>${escapeHtml(data.event.description)}</strong>
                                </div>
                                <div class="event-date-display">
                                    <i class="fas fa-calendar"></i> ${data.event.event_date}
                                </div>
                                ${data.event.notes ? `<div class="event-notes-display">${escapeHtml(data.event.notes)}</div>` : ''}
                            `;
                            eventItem.querySelector('.event-actions').style.display = '';
                            attachEventListeners();
                        } else {
                            alert('Error updating event: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating event. Please try again.');
                    });
                });
            });
        });
    }
    
    // Initial attachment
    attachEventListeners();
});
</script>
{% endblock %}

