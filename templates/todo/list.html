{% extends "base.html" %}

{% block title %}To Do{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/todo.css') }}">
{% endblock %}

{% block content %}
<div class="todo-container">
    <div class="todo-main-layout">
        <!-- Main Content: Todos -->
        <div class="todo-main-content">
            <div class="todo-header">
                <h1><i class="fas fa-tasks"></i> To Do</h1>
            </div>
            <!-- Add Todo Form -->
            <div class="todo-form-container">
        <form method="POST" action="{{ url_for('todo_list') }}" class="todo-form">
            {{ form.hidden_tag() }}
            <div class="row w-100">
                <div class="col-md-5">
                    {{ form.description.label(class="form-label") }}
                    {{ form.description(class="form-control") }}
                    {% if form.description.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.description.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    {{ form.due_date.label(class="form-label") }}
                    <div class="position-relative">
                        {{ form.due_date(class="form-control") }}
                        <i class="fas fa-calendar-alt position-absolute" style="right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #adb5bd; font-size: 0.85rem;"></i>
                    </div>
                    {% if form.due_date.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.due_date.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {{ form.goal_id.label(class="form-label") }}
                    {{ form.goal_id(class="form-control") }}
                    {% if form.goal_id.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.goal_id.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>
            </div>

            <!-- Todo List -->
            <div class="todo-list-container">
        {% if todos %}
            <ul class="todo-list">
                {% for todo in todos %}
                <li class="todo-item {% if todo.completed %}completed{% endif %}" data-todo-id="{{ todo.id }}">
                    <div class="todo-checkbox-container">
                        <input type="checkbox" 
                               class="todo-checkbox" 
                               {% if todo.completed %}checked{% endif %}
                               data-todo-id="{{ todo.id }}"
                               aria-label="Toggle todo completion">
                    </div>
                    <div class="todo-content">
                        <div class="todo-description {% if todo.completed %}text-muted text-decoration-line-through{% endif %}">
                            {{ todo.description }}
                        </div>
                        {% if todo.due_date %}
                        <div class="todo-due-date">
                            <i class="fas fa-calendar"></i> Due: {{ todo.due_date.strftime('%Y-%m-%d') }}
                        </div>
                        {% endif %}
                        {% if todo.goal %}
                        <div class="todo-goal-link">
                            <a href="{{ url_for('goals_list') }}" class="goal-link-badge">
                                <i class="fas fa-bullseye"></i> {{ todo.goal.title }}
                            </a>
                        </div>
                        {% endif %}
                        <div class="todo-meta">
                            <small class="text-muted">Created: {{ todo.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        
                        <!-- Subtasks Section -->
                        <div class="subtasks-container" data-todo-id="{{ todo.id }}">
                            <div class="subtasks-list">
                                {% if todo.subtasks_list %}
                                    {% for subtask in todo.subtasks_list %}
                                    <div class="subtask-item {% if subtask.completed %}completed{% endif %}" data-subtask-id="{{ subtask.id }}">
                                        <input type="checkbox" 
                                               class="subtask-checkbox" 
                                               {% if subtask.completed %}checked{% endif %}
                                               data-todo-id="{{ todo.id }}"
                                               data-subtask-id="{{ subtask.id }}"
                                               aria-label="Toggle subtask completion">
                                        <span class="subtask-description {% if subtask.completed %}text-muted text-decoration-line-through{% endif %}">
                                            {{ subtask.description }}
                                        </span>
                                        <button type="button" 
                                                class="btn btn-sm btn-link text-danger subtask-delete-btn p-0 ms-2" 
                                                data-todo-id="{{ todo.id }}"
                                                data-subtask-id="{{ subtask.id }}"
                                                aria-label="Delete subtask"
                                                title="Delete subtask">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="subtask-add-form">
                                <input type="text" 
                                       class="subtask-input form-control" 
                                       placeholder="Add a subtask..." 
                                       data-todo-id="{{ todo.id }}"
                                       style="display: none;">
                                <button type="button" 
                                        class="subtask-add-btn subtask-toggle-btn" 
                                        data-todo-id="{{ todo.id }}"
                                        title="Add subtask"
                                        aria-label="Add subtask">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="todo-actions">
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger todo-delete-btn" 
                                data-todo-id="{{ todo.id }}"
                                aria-label="Delete todo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-clipboard-list fa-3x"></i>
                <h3>No Todos Yet</h3>
                <p>Add your first todo using the form above.</p>
            </div>
        {% endif %}
            </div>
        </div>
        
        <!-- Sidebar: Events -->
        <div class="events-sidebar">
            <!-- Sticky Header Section -->
            <div class="events-sidebar-header">
                <div class="events-title">
                    <h2>Events</h2>
                </div>
                
                <!-- Tab Switcher -->
                <div class="events-tabs">
                    <button type="button" 
                            class="events-tab-btn active" 
                            data-tab="upcoming"
                            id="tabUpcoming">
                        Upcoming
                    </button>
                    <button type="button" 
                            class="events-tab-btn" 
                            data-tab="history"
                            id="tabHistory">
                        History
                    </button>
                </div>
                
                <!-- Compact Add Event Form -->
                <div class="event-add-compact">
                    <form class="event-form-compact" id="eventForm">
                        <input type="text" 
                               class="form-control event-title-input" 
                               placeholder="Event title" 
                               id="eventDescription"
                               required>
                        <button type="button" 
                                class="event-date-pill" 
                                id="eventDatePill"
                                title="Select date">
                            <i class="fas fa-calendar"></i>
                            <span id="eventDatePillText">Date</span>
                        </button>
                        <input type="date" 
                               class="event-date-input-hidden" 
                               id="eventDate"
                               required>
                        <button type="submit" class="event-add-icon-btn" title="Add event">
                            <i class="fas fa-plus"></i>
                        </button>
                    </form>
                    <button type="button" 
                            class="event-notes-link"
                            id="eventNotesToggle">
                        <i class="fas fa-pen"></i> Add notes
                    </button>
                    <div class="event-notes-expandable" id="eventNotesExpandable" style="display: none;">
                        <textarea class="form-control event-notes-input" 
                                  placeholder="Notes (optional)" 
                                  id="eventNotes"
                                  rows="2"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Scrollable Content Area -->
            <div class="events-scrollable">
                <!-- Upcoming Events List -->
                <div class="events-list-upcoming" id="eventsListUpcoming">
                    {% if upcoming_events or past_unprocessed_events %}
                        <div class="events-list">
                            {% if upcoming_events %}
                                {% for event in upcoming_events %}
                                <div class="event-row event-row-upcoming" data-event-id="{{ event.id }}">
                                    <div class="event-row-main">
                                        <div class="event-row-title">{{ event.description }}</div>
                                        <div class="event-row-meta">
                                            <span class="event-row-date">
                                                <i class="fas fa-calendar"></i> {{ event.event_date.strftime('%Y-%m-%d') }}
                                            </span>
                                            {% if event.notes %}
                                            <span class="event-row-has-notes" title="Has notes">
                                                <i class="fas fa-sticky-note"></i>
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="event-row-actions">
                                        <button type="button" 
                                                class="btn btn-sm btn-link event-edit-btn" 
                                                data-event-id="{{ event.id }}"
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-link text-danger event-delete-btn" 
                                                data-event-id="{{ event.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    {% if event.notes %}
                                    <div class="event-row-details" style="display: none;">
                                        <div class="event-row-notes">{{ event.notes }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if past_unprocessed_events %}
                                {% for event in past_unprocessed_events %}
                                <div class="event-row event-row-past-unprocessed" 
                                     data-event-id="{{ event.id }}"
                                     data-event-description="{{ event.description }}"
                                     data-event-date="{{ event.event_date.strftime('%Y-%m-%d') }}"
                                     style="cursor: pointer;">
                                    <div class="event-row-main">
                                        <div class="event-row-title">{{ event.description }}</div>
                                        <div class="event-row-meta">
                                            <span class="event-row-date">
                                                <i class="fas fa-calendar"></i> {{ event.event_date.strftime('%Y-%m-%d') }}
                                            </span>
                                            <span class="event-row-badge badge bg-warning text-dark">Needs Processing</span>
                                        </div>
                                    </div>
                                    <div class="event-row-actions">
                                        <button type="button" 
                                                class="btn btn-sm btn-link event-edit-btn" 
                                                data-event-id="{{ event.id }}"
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-link text-danger event-delete-btn" 
                                                data-event-id="{{ event.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="events-empty-state">
                            <p class="text-muted">No upcoming events.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- History List (Dense Expandable Rows) -->
                <div class="events-list-history" id="eventsListHistory" style="display: none;">
                    {% if processed_events %}
                        <div class="events-list">
                            {% for event in processed_events %}
                            <div class="event-row event-row-history" 
                                 data-event-id="{{ event.id }}"
                                 data-expanded="false">
                                <div class="event-row-main" style="cursor: pointer;">
                                    <div class="event-row-title">{{ event.description }}</div>
                                    <div class="event-row-meta">
                                        <span class="event-row-date">
                                            <i class="fas fa-calendar"></i> {{ event.event_date.strftime('%Y-%m-%d') }}
                                        </span>
                                        {% if event.outcome == 'did_not_happen' %}
                                            <span class="event-row-badge badge bg-warning text-dark">Didn't Happen</span>
                                        {% elif event.outcome == 'happened' %}
                                            <span class="event-row-badge badge bg-success">Happened</span>
                                        {% elif event.outcome == 'happened_with_notes' %}
                                            <span class="event-row-badge badge bg-info">Happened</span>
                                            <span class="event-row-has-notes" title="Has notes">
                                                <i class="fas fa-sticky-note"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="event-row-actions">
                                    <button type="button" 
                                            class="btn btn-sm btn-link event-edit-btn" 
                                            data-event-id="{{ event.id }}"
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-link text-danger event-delete-btn" 
                                            data-event-id="{{ event.id }}"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-link event-expand-btn" 
                                            title="Expand">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="event-row-details" style="display: none;">
                                    {% if event.outcome_reason %}
                                    <div class="event-row-detail-item">
                                        <strong>Reason:</strong> {{ event.outcome_reason }}
                                    </div>
                                    {% endif %}
                                    {% if event.outcome_notes %}
                                    <div class="event-row-detail-item">
                                        <strong>Notes:</strong>
                                        <div class="event-notes-content">{{ event.outcome_notes|safe }}</div>
                                    </div>
                                    {% endif %}
                                    {% if event.processed_at %}
                                    <div class="event-row-detail-item">
                                        <small class="text-muted">Processed: {{ event.processed_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="events-empty-state">
                            <p class="text-muted">No processed events.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Process Event Modal -->
        <div class="modal fade" id="processEventModal" tabindex="-1" aria-labelledby="processEventModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
                <div class="modal-content process-modal-content">
                    <div class="modal-header process-modal-header">
                        <div class="process-modal-title-section">
                            <h5 class="modal-title mb-0" id="processEventModalLabel">
                                <i class="fas fa-tasks me-2"></i>Process Event
                            </h5>
                            <div class="process-event-info">
                                <strong id="processEventDescription" class="process-event-name"></strong>
                                <span class="process-event-date" id="processEventDate"></span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body process-modal-body">
                        <form id="processEventForm">
                            <input type="hidden" id="processEventId" value="">
                            <div class="process-outcome-group">
                                <label class="process-form-label">Select Outcome:</label>
                                <div class="process-radio-group">
                                    <div class="process-radio-option">
                                        <input class="form-check-input" type="radio" name="outcome" id="outcomeDidNotHappen" value="did_not_happen">
                                        <label class="form-check-label" for="outcomeDidNotHappen">
                                            <i class="fas fa-times-circle me-1"></i>Didn't happen
                                        </label>
                                    </div>
                                    <div class="process-radio-option">
                                        <input class="form-check-input" type="radio" name="outcome" id="outcomeHappened" value="happened">
                                        <label class="form-check-label" for="outcomeHappened">
                                            <i class="fas fa-check-circle me-1"></i>Happened
                                        </label>
                                    </div>
                                    <div class="process-radio-option">
                                        <input class="form-check-input" type="radio" name="outcome" id="outcomeHappenedWithNotes" value="happened_with_notes">
                                        <label class="form-check-label" for="outcomeHappenedWithNotes">
                                            <i class="fas fa-sticky-note me-1"></i>Happened with notes
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reason field (shown only for "didn't happen") -->
                            <div class="process-field-group" id="reasonField" style="display: none;">
                                <label for="processEventReason" class="process-form-label">Reason <span class="text-muted">(optional)</span></label>
                                <textarea class="form-control process-textarea" id="processEventReason" rows="2" placeholder="Why didn't it happen?"></textarea>
                            </div>
                            
                            <!-- Notes and follow-ups fields (shown only for "happened with notes") -->
                            <div id="notesAndFollowupsFields" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <div class="process-field-group">
                                            <label for="processEventNotes" class="process-form-label">Notes</label>
                                            <div id="processEventNotesEditor" class="quill-editor-container-compact"></div>
                                            <input type="hidden" id="processEventNotes" value="">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="process-field-group">
                                            <label for="processEventFollowups" class="process-form-label">
                                                Follow-ups <span class="text-muted small">(one per line)</span>
                                            </label>
                                            <textarea class="form-control process-textarea" id="processEventFollowups" rows="8" placeholder="One per line..."></textarea>
                                            <small class="process-help-text">Each line becomes a new todo</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer process-modal-footer">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-sm btn-primary process-submit-btn" id="processEventSubmitBtn">
                            <span class="btn-text">Process</span>
                            <span class="btn-spinner" style="display: none;">
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>Processing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Event processed successfully!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/quill-config.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Define these at the top level of DOMContentLoaded so they're accessible everywhere
    const listUpcoming = document.getElementById('eventsListUpcoming');
    const listHistory = document.getElementById('eventsListHistory');
    
    // Get CSRF token from meta tag or form
    function getCSRFToken() {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
        // Fallback: get from form hidden field
        const form = document.querySelector('.todo-form');
        if (form) {
            const csrfInput = form.querySelector('input[name="csrf_token"]');
            if (csrfInput) {
                return csrfInput.value;
            }
        }
        return null;
    }
    
    // Handle checkbox toggle
    document.querySelectorAll('.todo-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const todoId = this.dataset.todoId;
            const todoItem = this.closest('.todo-item');
            const description = todoItem.querySelector('.todo-description');
            
            // Optimistic UI update
            if (this.checked) {
                todoItem.classList.add('completed');
                description.classList.add('text-muted', 'text-decoration-line-through');
            } else {
                todoItem.classList.remove('completed');
                description.classList.remove('text-muted', 'text-decoration-line-through');
            }
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/toggle`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert optimistic update on error
                    this.checked = !this.checked;
                    if (this.checked) {
                        todoItem.classList.add('completed');
                        description.classList.add('text-muted', 'text-decoration-line-through');
                    } else {
                        todoItem.classList.remove('completed');
                        description.classList.remove('text-muted', 'text-decoration-line-through');
                    }
                    alert('Error updating todo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                this.checked = !this.checked;
                if (this.checked) {
                    todoItem.classList.add('completed');
                    description.classList.add('text-muted', 'text-decoration-line-through');
                } else {
                    todoItem.classList.remove('completed');
                    description.classList.remove('text-muted', 'text-decoration-line-through');
                }
                console.error('Error:', error);
                alert('Error updating todo. Please try again.');
            });
        });
    });
    
    // Handle delete button
    document.querySelectorAll('.todo-delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const todoId = this.dataset.todoId;
            const todoItem = this.closest('.todo-item');
            
            if (!confirm('Are you sure you want to delete this todo?')) {
                return;
            }
            
            // Optimistic UI update
            todoItem.style.opacity = '0.5';
            todoItem.style.pointerEvents = 'none';
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/delete`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from DOM
                    todoItem.style.transition = 'opacity 0.3s ease-out';
                    todoItem.style.opacity = '0';
                    setTimeout(function() {
                        todoItem.remove();
                        
                        // Check if list is empty and show empty state
                        const todoList = document.querySelector('.todo-list');
                        if (todoList && todoList.children.length === 0) {
                            location.reload();
                        }
                    }, 300);
                } else {
                    // Revert optimistic update on error
                    todoItem.style.opacity = '1';
                    todoItem.style.pointerEvents = 'auto';
                    alert('Error deleting todo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                todoItem.style.opacity = '1';
                todoItem.style.pointerEvents = 'auto';
                console.error('Error:', error);
                alert('Error deleting todo. Please try again.');
            });
        });
    });
    
    // Handle subtask checkbox toggle
    document.querySelectorAll('.subtask-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const todoId = this.dataset.todoId;
            const subtaskId = this.dataset.subtaskId;
            const subtaskItem = this.closest('.subtask-item');
            const description = subtaskItem.querySelector('.subtask-description');
            
            // Optimistic UI update
            if (this.checked) {
                subtaskItem.classList.add('completed');
                description.classList.add('text-muted', 'text-decoration-line-through');
            } else {
                subtaskItem.classList.remove('completed');
                description.classList.remove('text-muted', 'text-decoration-line-through');
            }
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/subtasks/${subtaskId}/toggle`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert optimistic update on error
                    this.checked = !this.checked;
                    if (this.checked) {
                        subtaskItem.classList.add('completed');
                        description.classList.add('text-muted', 'text-decoration-line-through');
                    } else {
                        subtaskItem.classList.remove('completed');
                        description.classList.remove('text-muted', 'text-decoration-line-through');
                    }
                    alert('Error updating subtask: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                this.checked = !this.checked;
                if (this.checked) {
                    subtaskItem.classList.add('completed');
                    description.classList.add('text-muted', 'text-decoration-line-through');
                } else {
                    subtaskItem.classList.remove('completed');
                    description.classList.remove('text-muted', 'text-decoration-line-through');
                }
                console.error('Error:', error);
                alert('Error updating subtask. Please try again.');
            });
        });
    });
    
    // Handle subtask delete button
    document.querySelectorAll('.subtask-delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const todoId = this.dataset.todoId;
            const subtaskId = this.dataset.subtaskId;
            const subtaskItem = this.closest('.subtask-item');
            
            // Optimistic UI update
            subtaskItem.style.opacity = '0.5';
            subtaskItem.style.pointerEvents = 'none';
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/subtasks/${subtaskId}/delete`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from DOM
                    subtaskItem.style.transition = 'opacity 0.3s ease-out';
                    subtaskItem.style.opacity = '0';
                    setTimeout(function() {
                        subtaskItem.remove();
                    }, 300);
                } else {
                    // Revert optimistic update on error
                    subtaskItem.style.opacity = '1';
                    subtaskItem.style.pointerEvents = 'auto';
                    alert('Error deleting subtask: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Revert optimistic update on error
                subtaskItem.style.opacity = '1';
                subtaskItem.style.pointerEvents = 'auto';
                console.error('Error:', error);
                alert('Error deleting subtask. Please try again.');
            });
        });
    });
    
    // Handle subtask toggle button (+ button) - show/hide input
    document.querySelectorAll('.subtask-toggle-btn').forEach(function(toggleBtn) {
        const form = toggleBtn.closest('.subtask-add-form');
        const input = form.querySelector('.subtask-input');
        const todoId = toggleBtn.dataset.todoId;
        
        // Function to show input and focus it
        const showInput = function() {
            input.style.display = 'block';
            setTimeout(() => input.focus(), 10);
        };
        
        // Function to add subtask
        const addSubtask = function() {
            const description = input.value.trim();
            
            if (!description) {
                // If no text, just show the input
                showInput();
                return;
            }
            
            // Clear input
            input.value = '';
            input.disabled = true;
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(`/todos/${todoId}/subtasks/create`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ description: description })
            })
            .then(response => response.json())
            .then(data => {
                input.disabled = false;
                if (data.success && data.subtask) {
                    // Add subtask to DOM
                    const subtasksList = input.closest('.subtasks-container').querySelector('.subtasks-list');
                    const subtaskHtml = `
                        <div class="subtask-item" data-subtask-id="${data.subtask.id}">
                            <input type="checkbox" 
                                   class="subtask-checkbox" 
                                   data-todo-id="${todoId}"
                                   data-subtask-id="${data.subtask.id}"
                                   aria-label="Toggle subtask completion">
                            <span class="subtask-description">
                                ${escapeHtml(data.subtask.description)}
                            </span>
                            <button type="button" 
                                    class="btn btn-sm btn-link text-danger subtask-delete-btn p-0 ms-2" 
                                    data-todo-id="${todoId}"
                                    data-subtask-id="${data.subtask.id}"
                                    aria-label="Delete subtask"
                                    title="Delete subtask">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    subtasksList.insertAdjacentHTML('beforeend', subtaskHtml);
                    
                    // Re-attach event listeners to new elements
                    const newCheckbox = subtasksList.querySelector(`.subtask-checkbox[data-subtask-id="${data.subtask.id}"]`);
                    const newDeleteBtn = subtasksList.querySelector(`.subtask-delete-btn[data-subtask-id="${data.subtask.id}"]`);
                    
                    if (newCheckbox) {
                        newCheckbox.addEventListener('change', function() {
                            const todoId = this.dataset.todoId;
                            const subtaskId = this.dataset.subtaskId;
                            const subtaskItem = this.closest('.subtask-item');
                            const description = subtaskItem.querySelector('.subtask-description');
                            
                            if (this.checked) {
                                subtaskItem.classList.add('completed');
                                description.classList.add('text-muted', 'text-decoration-line-through');
                            } else {
                                subtaskItem.classList.remove('completed');
                                description.classList.remove('text-muted', 'text-decoration-line-through');
                            }
                            
                            const headers = {
                                'Content-Type': 'application/json',
                            };
                            const csrfToken = getCSRFToken();
                            if (csrfToken) {
                                headers['X-CSRFToken'] = csrfToken;
                            }
                            
                            fetch(`/todos/${todoId}/subtasks/${subtaskId}/toggle`, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify({})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (!data.success) {
                                    this.checked = !this.checked;
                                    if (this.checked) {
                                        subtaskItem.classList.add('completed');
                                        description.classList.add('text-muted', 'text-decoration-line-through');
                                    } else {
                                        subtaskItem.classList.remove('completed');
                                        description.classList.remove('text-muted', 'text-decoration-line-through');
                                    }
                                }
                            });
                        });
                    }
                    
                    if (newDeleteBtn) {
                        newDeleteBtn.addEventListener('click', function() {
                            const todoId = this.dataset.todoId;
                            const subtaskId = this.dataset.subtaskId;
                            const subtaskItem = this.closest('.subtask-item');
                            
                            subtaskItem.style.opacity = '0.5';
                            subtaskItem.style.pointerEvents = 'none';
                            
                            const headers = {
                                'Content-Type': 'application/json',
                            };
                            const csrfToken = getCSRFToken();
                            if (csrfToken) {
                                headers['X-CSRFToken'] = csrfToken;
                            }
                            
                            fetch(`/todos/${todoId}/subtasks/${subtaskId}/delete`, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify({})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    subtaskItem.style.transition = 'opacity 0.3s ease-out';
                                    subtaskItem.style.opacity = '0';
                                    setTimeout(function() {
                                        subtaskItem.remove();
                                    }, 300);
                                } else {
                                    subtaskItem.style.opacity = '1';
                                    subtaskItem.style.pointerEvents = 'auto';
                                }
                            });
                        });
                    }
                    
                    // Hide input after successfully adding (saves space)
                    input.style.display = 'none';
                } else {
                    alert('Error creating subtask: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                input.disabled = false;
                console.error('Error:', error);
                alert('Error creating subtask. Please try again.');
            });
        };
        
        // Toggle button click - show input if hidden, add subtask if visible and has text
        toggleBtn.addEventListener('click', function() {
            if (input.style.display === 'none' || !input.offsetParent) {
                showInput();
            } else {
                addSubtask();
            }
        });
        
        // Handle Enter key in input
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSubtask();
            }
        });
        
        // Hide input when it loses focus and is empty (saves space)
        input.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.style.display = 'none';
            }
        });
    });
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Tab switching functionality
    const tabUpcoming = document.getElementById('tabUpcoming');
    const tabHistory = document.getElementById('tabHistory');
    
    if (tabUpcoming && tabHistory && listUpcoming && listHistory) {
        function switchTab(activeTab) {
            if (activeTab === 'upcoming') {
                tabUpcoming.classList.add('active');
                tabHistory.classList.remove('active');
                listUpcoming.style.display = 'block';
                listHistory.style.display = 'none';
            } else {
                tabHistory.classList.add('active');
                tabUpcoming.classList.remove('active');
                listHistory.style.display = 'block';
                listUpcoming.style.display = 'none';
            }
        }
        
        tabUpcoming.addEventListener('click', function() {
            switchTab('upcoming');
        });
        
        tabHistory.addEventListener('click', function() {
            switchTab('history');
        });
    }
    
    // Date pill functionality
    const datePill = document.getElementById('eventDatePill');
    const datePillText = document.getElementById('eventDatePillText');
    const dateInput = document.getElementById('eventDate');
    
    if (datePill && dateInput && datePillText) {
        // Update pill text when date changes
        dateInput.addEventListener('change', function() {
            if (this.value) {
                const date = new Date(this.value);
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                if (this.value === today.toISOString().split('T')[0]) {
                    datePillText.textContent = 'Today';
                } else if (this.value === tomorrow.toISOString().split('T')[0]) {
                    datePillText.textContent = 'Tomorrow';
                } else {
                    datePillText.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } else {
                datePillText.textContent = 'Date';
            }
        });
        
        // Click pill to trigger date input
        datePill.addEventListener('click', function() {
            dateInput.showPicker ? dateInput.showPicker() : dateInput.click();
        });
    }
    
    // Expandable notes in add form
    const notesToggle = document.getElementById('eventNotesToggle');
    const notesExpandable = document.getElementById('eventNotesExpandable');
    
    if (notesToggle && notesExpandable) {
        notesToggle.addEventListener('click', function() {
            const isVisible = notesExpandable.style.display !== 'none';
            notesExpandable.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                notesExpandable.querySelector('textarea').focus();
            }
        });
    }
    
    // History row expand/collapse
    document.querySelectorAll('.event-row-history').forEach(function(row) {
        const expandBtn = row.querySelector('.event-expand-btn');
        const details = row.querySelector('.event-row-details');
        const main = row.querySelector('.event-row-main');
        
        if (expandBtn && details) {
            const toggleExpand = function(e) {
                // Don't expand if clicking on action buttons
                if (e.target.closest('.event-row-actions')) {
                    return;
                }
                
                const isExpanded = row.dataset.expanded === 'true';
                row.dataset.expanded = !isExpanded;
                details.style.display = isExpanded ? 'none' : 'block';
                const icon = expandBtn.querySelector('i');
                if (icon) {
                    icon.className = isExpanded ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                }
            };
            
            if (main) {
                main.addEventListener('click', toggleExpand);
            }
            expandBtn.addEventListener('click', toggleExpand);
        }
    });
    
    // Handle event form submission
    const eventForm = document.getElementById('eventForm');
    if (eventForm) {
        eventForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const description = document.getElementById('eventDescription').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const notesEl = document.getElementById('eventNotes');
            const notes = notesEl ? notesEl.value.trim() : '';
            
            if (!description || !eventDate) {
                alert('Please fill in description and date');
                return;
            }
            
            // Disable form
            const submitBtn = eventForm.querySelector('.event-add-icon-btn');
            if (submitBtn) submitBtn.disabled = true;
            
            // Send AJAX request
            const headers = {
                'Content-Type': 'application/json',
            };
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch('/events/create', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    description: description,
                    event_date: eventDate,
                    notes: notes || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (submitBtn) submitBtn.disabled = false;
                if (data.success && data.event) {
                    // Reset form
                    eventForm.reset();
                    if (datePillText) datePillText.textContent = 'Date';
                    if (notesExpandable) notesExpandable.style.display = 'none';
                    
                    // Add event to DOM in upcoming list
                    const eventsList = listUpcoming ? listUpcoming.querySelector('.events-list') : null;
                    const emptyState = listUpcoming ? listUpcoming.querySelector('.events-empty-state') : null;
                    
                    if (emptyState) {
                        emptyState.remove();
                    }
                    
                    if (!eventsList && listUpcoming) {
                        const newList = document.createElement('div');
                        newList.className = 'events-list';
                        listUpcoming.appendChild(newList);
                    }
                    
                    const targetList = listUpcoming ? listUpcoming.querySelector('.events-list') : null;
                    if (targetList) {
                        const eventHtml = `
                            <div class="event-row event-row-upcoming" data-event-id="${data.event.id}">
                                <div class="event-row-main">
                                    <div class="event-row-title">${escapeHtml(data.event.description)}</div>
                                    <div class="event-row-meta">
                                        <span class="event-row-date">
                                            <i class="fas fa-calendar"></i> ${data.event.event_date}
                                        </span>
                                        ${data.event.notes ? '<span class="event-row-has-notes" title="Has notes"><i class="fas fa-sticky-note"></i></span>' : ''}
                                    </div>
                                </div>
                                <div class="event-row-actions">
                                    <button type="button" 
                                            class="btn btn-sm btn-link event-edit-btn" 
                                            data-event-id="${data.event.id}"
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-link text-danger event-delete-btn" 
                                            data-event-id="${data.event.id}"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                ${data.event.notes ? `<div class="event-row-details" style="display: none;"><div class="event-row-notes">${escapeHtml(data.event.notes)}</div></div>` : ''}
                            </div>
                        `;
                        targetList.insertAdjacentHTML('beforeend', eventHtml);
                        
                        // Re-attach event listeners
                        attachEventListeners();
                    }
                } else {
                    alert('Error creating event: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                if (submitBtn) submitBtn.disabled = false;
                console.error('Error:', error);
                alert('Error creating event. Please try again.');
            });
        });
    }
    
    // Function to attach event listeners
    function attachEventListeners() {
        // Handle event delete
        document.querySelectorAll('.event-delete-btn').forEach(function(button) {
            if (button.dataset.listenerAttached) return;
            button.dataset.listenerAttached = 'true';
            
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent row expand/collapse
                const eventId = this.dataset.eventId;
                const eventRow = this.closest('.event-row');
                
                if (!confirm('Are you sure you want to delete this event?')) {
                    return;
                }
                
                eventRow.style.opacity = '0.5';
                eventRow.style.pointerEvents = 'none';
                
                const headers = {
                    'Content-Type': 'application/json',
                };
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }
                
                fetch(`/events/${eventId}/delete`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        eventRow.style.transition = 'opacity 0.3s ease-out';
                        eventRow.style.opacity = '0';
                        setTimeout(function() {
                            eventRow.remove();
                            const eventsList = eventRow.closest('.events-list');
                            if (eventsList && eventsList.children.length === 0) {
                                const container = eventRow.closest('.events-list-upcoming, .events-list-history');
                                if (container) {
                                    const emptyState = document.createElement('div');
                                    emptyState.className = 'events-empty-state';
                                    emptyState.innerHTML = '<p class="text-muted">No events.</p>';
                                    container.appendChild(emptyState);
                                }
                            }
                        }, 300);
                    } else {
                        eventRow.style.opacity = '1';
                        eventRow.style.pointerEvents = 'auto';
                        alert('Error deleting event: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    eventRow.style.opacity = '1';
                    eventRow.style.pointerEvents = 'auto';
                    console.error('Error:', error);
                    alert('Error deleting event. Please try again.');
                });
            });
        });
        
        // Handle event edit
        document.querySelectorAll('.event-edit-btn').forEach(function(button) {
            if (button.dataset.listenerAttached) return;
            button.dataset.listenerAttached = 'true';
            
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent row expand/collapse
                const eventId = this.dataset.eventId;
                const eventRow = this.closest('.event-row');
                const titleEl = eventRow.querySelector('.event-row-title');
                const dateEl = eventRow.querySelector('.event-row-date');
                
                // Get notes - check both regular notes and outcome notes
                let notesEl = eventRow.querySelector('.event-row-notes');
                if (!notesEl) {
                    // For processed events, try to get outcome notes
                    const outcomeNotesEl = eventRow.querySelector('.event-notes-content');
                    if (outcomeNotesEl) {
                        // Create a temporary element to extract text from HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = outcomeNotesEl.innerHTML;
                        notesEl = { textContent: tempDiv.textContent || tempDiv.innerText || '' };
                    }
                }
                
                const currentDescription = titleEl ? titleEl.textContent.trim() : '';
                const dateMatch = dateEl ? dateEl.textContent.match(/\d{4}-\d{2}-\d{2}/) : null;
                const currentDate = dateMatch ? dateMatch[0] : '';
                const currentNotes = notesEl ? notesEl.textContent.trim() : '';
                
                // Create edit form
                const editForm = document.createElement('form');
                editForm.className = 'event-edit-form';
                editForm.innerHTML = `
                    <input type="text" 
                           class="form-control event-edit-description" 
                           value="${escapeHtml(currentDescription)}" 
                           required>
                    <input type="date" 
                           class="form-control event-edit-date" 
                           value="${currentDate}" 
                           required>
                    <textarea class="form-control event-edit-notes" 
                              rows="2">${escapeHtml(currentNotes)}</textarea>
                    <div class="event-edit-actions">
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary event-cancel-edit">Cancel</button>
                    </div>
                `;
                
                const originalMain = eventRow.querySelector('.event-row-main').innerHTML;
                const originalActions = eventRow.querySelector('.event-row-actions').innerHTML;
                const originalDetails = eventRow.querySelector('.event-row-details') ? eventRow.querySelector('.event-row-details').innerHTML : '';
                
                eventRow.querySelector('.event-row-main').innerHTML = '';
                eventRow.querySelector('.event-row-main').appendChild(editForm);
                eventRow.querySelector('.event-row-actions').style.display = 'none';
                if (eventRow.querySelector('.event-row-details')) {
                    eventRow.querySelector('.event-row-details').style.display = 'none';
                }
                
                // Handle cancel
                editForm.querySelector('.event-cancel-edit').addEventListener('click', function() {
                    eventRow.querySelector('.event-row-main').innerHTML = originalMain;
                    eventRow.querySelector('.event-row-actions').innerHTML = originalActions;
                    eventRow.querySelector('.event-row-actions').style.display = '';
                    if (originalDetails && eventRow.querySelector('.event-row-details')) {
                        eventRow.querySelector('.event-row-details').innerHTML = originalDetails;
                    }
                    attachEventListeners();
                });
                
                // Handle submit
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newDescription = editForm.querySelector('.event-edit-description').value.trim();
                    const newDate = editForm.querySelector('.event-edit-date').value;
                    const newNotes = editForm.querySelector('.event-edit-notes').value.trim();
                    
                    if (!newDescription || !newDate) {
                        alert('Please fill in description and date');
                        return;
                    }
                    
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    const csrfToken = getCSRFToken();
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }
                    
                    fetch(`/events/${eventId}/update`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            description: newDescription,
                            event_date: newDate,
                            notes: newNotes || null
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.event) {
                            // Check if this is a processed event
                            const isProcessed = eventRow.classList.contains('event-row-history');
                            
                            // Build event row content
                            let titleHtml = escapeHtml(data.event.description);
                            let metaHtml = `<span class="event-row-date"><i class="fas fa-calendar"></i> ${data.event.event_date}</span>`;
                            
                            // Add badge if processed
                            if (isProcessed && data.event.outcome) {
                                if (data.event.outcome === 'did_not_happen') {
                                    metaHtml += `<span class="event-row-badge badge bg-warning text-dark">Didn't Happen</span>`;
                                } else if (data.event.outcome === 'happened') {
                                    metaHtml += `<span class="event-row-badge badge bg-success">Happened</span>`;
                                } else if (data.event.outcome === 'happened_with_notes') {
                                    metaHtml += `<span class="event-row-badge badge bg-info">Happened</span>`;
                                    metaHtml += `<span class="event-row-has-notes" title="Has notes"><i class="fas fa-sticky-note"></i></span>`;
                                }
                            } else if (data.event.notes) {
                                metaHtml += `<span class="event-row-has-notes" title="Has notes"><i class="fas fa-sticky-note"></i></span>`;
                            }
                            
                            // Build details section for processed events
                            let detailsHtml = '';
                            if (isProcessed) {
                                detailsHtml = '<div class="event-row-details" style="display: none;">';
                                if (data.event.outcome_reason) {
                                    detailsHtml += `<div class="event-row-detail-item"><strong>Reason:</strong> ${escapeHtml(data.event.outcome_reason)}</div>`;
                                }
                                if (data.event.outcome_notes) {
                                    detailsHtml += `<div class="event-row-detail-item"><strong>Notes:</strong><div class="event-notes-content">${data.event.outcome_notes}</div></div>`;
                                }
                                if (data.event.processed_at) {
                                    detailsHtml += `<div class="event-row-detail-item"><small class="text-muted">Processed: ${data.event.processed_at}</small></div>`;
                                }
                                detailsHtml += '</div>';
                            } else if (data.event.notes) {
                                detailsHtml = `<div class="event-row-details" style="display: none;"><div class="event-row-notes">${escapeHtml(data.event.notes)}</div></div>`;
                            }
                            
                            // Update DOM
                            eventRow.querySelector('.event-row-main').innerHTML = `
                                <div class="event-row-title">${titleHtml}</div>
                                <div class="event-row-meta">${metaHtml}</div>
                            `;
                            if (detailsHtml) {
                                if (eventRow.querySelector('.event-row-details')) {
                                    eventRow.querySelector('.event-row-details').outerHTML = detailsHtml;
                                } else {
                                    eventRow.insertAdjacentHTML('beforeend', detailsHtml);
                                }
                            }
                            eventRow.querySelector('.event-row-actions').style.display = '';
                            attachEventListeners();
                        } else {
                            alert('Error updating event: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating event. Please try again.');
                    });
                });
            });
        });
    }
    
    // Initial attachment
    attachEventListeners();
    
    // Quill editor instance for notes
    let notesQuill = null;
    
    // Initialize Quill editor when modal is shown
    const processModal = document.getElementById('processEventModal');
    if (processModal) {
        processModal.addEventListener('shown.bs.modal', function() {
            // Initialize Quill editor for notes if it doesn't exist
            const notesEditorContainer = document.getElementById('processEventNotesEditor');
            const notesHiddenInput = document.getElementById('processEventNotes');
            
            if (notesEditorContainer && notesHiddenInput && !notesQuill) {
                notesQuill = window.initQuillEditor('processEventNotesEditor', 'processEventNotes', '');
            }
        });
        
        processModal.addEventListener('hidden.bs.modal', function() {
            // Clean up Quill editor when modal is closed
            if (notesQuill) {
                const notesEditorContainer = document.getElementById('processEventNotesEditor');
                if (notesEditorContainer) {
                    notesEditorContainer.innerHTML = '';
                }
                notesQuill = null;
            }
        });
    }
    
    // Toast notification helper function
    function showToast(title, message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // Update icon and color based on type
        toastIcon.className = 'fas me-2';
        if (type === 'success') {
            toastIcon.classList.add('fa-check-circle', 'text-success');
        } else if (type === 'error') {
            toastIcon.classList.add('fa-exclamation-circle', 'text-danger');
        } else if (type === 'info') {
            toastIcon.classList.add('fa-info-circle', 'text-info');
        }
        
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: type === 'error' ? 5000 : 3000
        });
        bsToast.show();
    }
    
    // Handle past unprocessed event clicks to open processing modal
    document.querySelectorAll('.event-row-past-unprocessed').forEach(function(eventRow) {
        const main = eventRow.querySelector('.event-row-main');
        if (main) {
            main.addEventListener('click', function(e) {
                // Don't trigger if clicking on action buttons
                if (e.target.closest('.event-row-actions')) {
                    return;
                }
                
                const eventId = eventRow.dataset.eventId;
                const eventDescription = eventRow.dataset.eventDescription;
                const eventDate = eventRow.dataset.eventDate;
            
            // Populate modal
            document.getElementById('processEventId').value = eventId;
            document.getElementById('processEventDescription').textContent = eventDescription;
            document.getElementById('processEventDate').textContent = eventDate;
            
            // Reset form
            document.getElementById('processEventForm').reset();
            document.getElementById('processEventId').value = eventId;
            document.getElementById('reasonField').style.display = 'none';
            document.getElementById('notesAndFollowupsFields').style.display = 'none';
            
            // Reset Quill editor if it exists
            if (notesQuill) {
                notesQuill.setText('');
            }
            
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('processEventModal'));
                modal.show();
            });
        }
    });
    
    // Handle outcome radio button changes to show/hide fields
    document.querySelectorAll('input[name="outcome"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const reasonField = document.getElementById('reasonField');
            const notesAndFollowupsFields = document.getElementById('notesAndFollowupsFields');
            
            if (this.value === 'did_not_happen') {
                reasonField.style.display = 'block';
                notesAndFollowupsFields.style.display = 'none';
            } else if (this.value === 'happened_with_notes') {
                reasonField.style.display = 'none';
                notesAndFollowupsFields.style.display = 'block';
            } else {
                reasonField.style.display = 'none';
                notesAndFollowupsFields.style.display = 'none';
            }
        });
    });
    
    // Handle process event form submission
    document.getElementById('processEventSubmitBtn').addEventListener('click', function() {
        const eventId = document.getElementById('processEventId').value;
        const outcome = document.querySelector('input[name="outcome"]:checked');
        
        if (!outcome) {
            showToast('Required', 'Please select an outcome', 'error');
            return;
        }
        
        const outcomeValue = outcome.value;
        const reason = document.getElementById('processEventReason').value.trim();
        
        // Get notes from Quill editor or hidden input
        let notes = '';
        if (notesQuill) {
            const html = notesQuill.root.innerHTML;
            if (html && html !== '<p><br></p>' && html !== '<p></p>') {
                notes = html;
            }
        } else {
            notes = document.getElementById('processEventNotes').value.trim();
        }
        
        const followUps = document.getElementById('processEventFollowups').value.trim();
        
        // Disable button and show spinner
        const btnText = this.querySelector('.btn-text');
        const btnSpinner = this.querySelector('.btn-spinner');
        this.disabled = true;
        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.style.display = 'inline';
        
        // Prepare request data
        const requestData = {
            outcome: outcomeValue
        };
        
        if (outcomeValue === 'did_not_happen' && reason) {
            requestData.reason = reason;
        } else if (outcomeValue === 'happened_with_notes') {
            if (notes) {
                requestData.notes = notes;
            }
            if (followUps) {
                requestData.follow_ups = followUps;
            }
        }
        
        // Send AJAX request
        const headers = {
            'Content-Type': 'application/json',
        };
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        fetch(`/events/${eventId}/process`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Re-enable button
            this.disabled = false;
            const btnText = this.querySelector('.btn-text');
            const btnSpinner = this.querySelector('.btn-spinner');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.style.display = 'none';
            
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('processEventModal'));
                modal.hide();
                
                // Remove from past unprocessed list (in upcoming tab)
                const eventRow = document.querySelector(`.event-row-past-unprocessed[data-event-id="${eventId}"]`);
                if (eventRow) {
                    eventRow.remove();
                    const eventsList = listUpcoming ? listUpcoming.querySelector('.events-list') : null;
                    if (eventsList && eventsList.children.length === 0) {
                        const emptyState = document.createElement('div');
                        emptyState.className = 'events-empty-state';
                        emptyState.innerHTML = '<p class="text-muted">No upcoming events.</p>';
                        listUpcoming.appendChild(emptyState);
                    }
                }
                
                // Add to processed events list (in history tab)
                const historyList = listHistory ? listHistory.querySelector('.events-list') : null;
                if (historyList) {
                    const outcomeBadge = data.event.outcome === 'did_not_happen' 
                        ? '<span class="event-row-badge badge bg-warning text-dark">Didn\'t Happen</span>'
                        : data.event.outcome === 'happened'
                        ? '<span class="event-row-badge badge bg-success">Happened</span>'
                        : '<span class="event-row-badge badge bg-info">Happened</span>';
                    
                    const hasNotes = data.event.outcome === 'happened_with_notes' && data.event.outcome_notes;
                    const notesIcon = hasNotes ? '<span class="event-row-has-notes" title="Has notes"><i class="fas fa-sticky-note"></i></span>' : '';
                    
                    let detailsHtml = '<div class="event-row-details" style="display: none;">';
                    if (data.event.outcome_reason) {
                        detailsHtml += `<div class="event-row-detail-item"><strong>Reason:</strong> ${escapeHtml(data.event.outcome_reason)}</div>`;
                    }
                    if (data.event.outcome_notes) {
                        detailsHtml += `<div class="event-row-detail-item"><strong>Notes:</strong><div class="event-notes-content">${data.event.outcome_notes}</div></div>`;
                    }
                    if (data.event.processed_at) {
                        detailsHtml += `<div class="event-row-detail-item"><small class="text-muted">Processed: ${data.event.processed_at}</small></div>`;
                    }
                    detailsHtml += '</div>';
                    
                    const eventHtml = `
                        <div class="event-row event-row-history" data-event-id="${data.event.id}" data-expanded="false">
                            <div class="event-row-main" style="cursor: pointer;">
                                <div class="event-row-title">${escapeHtml(data.event.description)}</div>
                                <div class="event-row-meta">
                                    <span class="event-row-date">
                                        <i class="fas fa-calendar"></i> ${data.event.event_date}
                                    </span>
                                    ${outcomeBadge}
                                    ${notesIcon}
                                </div>
                            </div>
                            <div class="event-row-actions">
                                <button type="button" 
                                        class="btn btn-sm btn-link event-edit-btn" 
                                        data-event-id="${data.event.id}"
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-link text-danger event-delete-btn" 
                                        data-event-id="${data.event.id}"
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-link event-expand-btn" 
                                        title="Expand">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            ${detailsHtml}
                        </div>
                    `;
                    historyList.insertAdjacentHTML('afterbegin', eventHtml);
                    
                    // Re-attach event listeners for the new row
                    attachEventListeners();
                    
                    // Attach expand/collapse handler
                    const newRow = historyList.querySelector(`.event-row-history[data-event-id="${data.event.id}"]`);
                    if (newRow) {
                        const expandBtn = newRow.querySelector('.event-expand-btn');
                        const details = newRow.querySelector('.event-row-details');
                        const main = newRow.querySelector('.event-row-main');
                        
                        if (expandBtn && details && main) {
                            const toggleExpand = function(e) {
                                if (e.target.closest('.event-row-actions')) {
                                    return;
                                }
                                const isExpanded = newRow.dataset.expanded === 'true';
                                newRow.dataset.expanded = !isExpanded;
                                details.style.display = isExpanded ? 'none' : 'block';
                                const icon = expandBtn.querySelector('i');
                                if (icon) {
                                    icon.className = isExpanded ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                                }
                            };
                            main.addEventListener('click', toggleExpand);
                            expandBtn.addEventListener('click', toggleExpand);
                        }
                    }
                } else {
                    // Create history list if it doesn't exist
                    if (listHistory) {
                        const newList = document.createElement('div');
                        newList.className = 'events-list';
                        listHistory.appendChild(newList);
                        
                        // Recursively call to add the event
                        setTimeout(() => {
                            const processBtn = document.getElementById('processEventSubmitBtn');
                            if (processBtn) {
                                processBtn.click();
                            }
                        }, 100);
                    }
                }
                
                // Show success message
                if (data.follow_ups_created > 0) {
                    showToast('Success', `Event processed! ${data.follow_ups_created} follow-up todo(s) created.`, 'success');
                    // Reload page to refresh todos list
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Success', 'Event processed successfully!', 'success');
                }
            } else {
                showToast('Error', data.error || 'Unknown error occurred', 'error');
            }
        })
        .catch(error => {
            // Re-enable button
            this.disabled = false;
            const btnText = this.querySelector('.btn-text');
            const btnSpinner = this.querySelector('.btn-spinner');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.style.display = 'none';
            console.error('Error:', error);
            showToast('Error', 'Failed to process event. Please try again.', 'error');
        });
    });
});
</script>
{% endblock %}

