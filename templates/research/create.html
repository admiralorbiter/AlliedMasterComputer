{% extends "base.html" %}

{% block title %}Create Research Brief{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/research.css') }}">
{% endblock %}

{% block content %}
<div class="research-container">
    <div class="research-header">
        <h1>Create Research Brief</h1>
        <a href="{{ url_for('research_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="research-form-card">
        <form method="POST" enctype="multipart/form-data" id="briefForm">
            {{ form.hidden_tag() }}
            
            <div class="form-section">
                <h3>Select Input Type</h3>
                <div class="form-group">
                    {{ form.source_type.label(class="form-label") }}
                    <div class="radio-group">
                        {% for subfield in form.source_type %}
                            <div class="form-check">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.source_type.errors %}
                        <div class="text-danger">
                            {% for error in form.source_type.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section" id="pdfSection" style="display: none;">
                <h3>Upload PDF(s)</h3>
                <div class="form-group">
                    {{ form.pdf_file.label(class="form-label") }}
                    {{ form.pdf_file(class="form-control", multiple=True) }}
                    <small class="form-text text-muted">You can select multiple PDF files. Maximum 25 MB per file, 100 MB total. Only PDF files are accepted.</small>
                    {% if form.pdf_file.errors %}
                        <div class="text-danger">
                            {% for error in form.pdf_file.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div id="fileList" class="mt-3" style="display: none;">
                        <h5>Selected Files:</h5>
                        <ul id="fileListItems" class="list-group"></ul>
                    </div>
                </div>
            </div>

            <div class="form-section" id="textSection">
                <h3>Enter Source Text</h3>
                <div class="form-group">
                    {{ form.source_text.label(class="form-label") }}
                    {{ form.source_text(class="form-control") }}
                    <small class="form-text text-muted">Minimum 50 characters required.</small>
                    {% if form.source_text.errors %}
                        <div class="text-danger">
                            {% for error in form.source_text.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section">
                <h3>Tags (Optional)</h3>
                <div class="form-group">
                    {{ form.tags.label(class="form-label") }}
                    {{ form.tags(class="form-control") }}
                    <small class="form-text text-muted">Add tags separated by commas. These tags will be applied to all uploaded briefs.</small>
                    {% if form.tags.errors %}
                        <div class="text-danger">
                            {% for error in form.tags.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-actions">
                {{ form.submit(class="btn btn-primary btn-lg") }}
                <a href="{{ url_for('research_list') }}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Processing PDF(s)... This may take a moment.</p>
            <p class="mt-2 text-muted" id="processingStatus"></p>
        </div>
    </div>

    {% if batch_results %}
    <div class="research-form-card mt-4">
        <h3>Processing Results</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Status</th>
                        <th>Message</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in batch_results %}
                    <tr>
                        <td>{{ result.filename }}</td>
                        <td>
                            {% if result.status == 'success' %}
                                <span class="badge bg-success">Success</span>
                            {% elif result.status == 'duplicate' %}
                                <span class="badge bg-warning">Duplicate</span>
                            {% else %}
                                <span class="badge bg-danger">Error</span>
                            {% endif %}
                        </td>
                        <td>{{ result.message }}</td>
                        <td>
                            {% if result.status == 'success' and result.brief_id %}
                                <a href="{{ url_for('research_view', id=result.brief_id) }}" class="btn btn-sm btn-primary">
                                    View Brief
                                </a>
                            {% elif result.status == 'duplicate' and result.brief_id %}
                                <a href="{{ url_for('research_view', id=result.brief_id) }}" class="btn btn-sm btn-secondary">
                                    View Existing
                                </a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <a href="{{ url_for('research_create') }}" class="btn btn-primary">Upload More PDFs</a>
            <a href="{{ url_for('research_list') }}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceTypeRadios = document.querySelectorAll('input[name="source_type"]');
    const pdfSection = document.getElementById('pdfSection');
    const textSection = document.getElementById('textSection');
    const form = document.getElementById('briefForm');

    // Toggle sections based on source type
    function updateSections() {
        const selectedType = document.querySelector('input[name="source_type"]:checked').value;
        if (selectedType === 'pdf') {
            pdfSection.style.display = 'block';
            textSection.style.display = 'none';
            document.getElementById('source_text').required = false;
            document.getElementById('pdf_file').required = true;
        } else {
            pdfSection.style.display = 'none';
            textSection.style.display = 'block';
            document.getElementById('source_text').required = true;
            document.getElementById('pdf_file').required = false;
        }
    }

    // Add event listeners
    sourceTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateSections);
    });

    // Initial update
    updateSections();

    // Handle file selection for PDF uploads
    const pdfFileInput = document.getElementById('pdf_file');
    const fileList = document.getElementById('fileList');
    const fileListItems = document.getElementById('fileListItems');
    
    if (pdfFileInput) {
        pdfFileInput.addEventListener('change', function() {
            const files = this.files;
            if (files && files.length > 0) {
                fileList.style.display = 'block';
                fileListItems.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    const fileInfo = document.createElement('span');
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    fileInfo.textContent = `${file.name} (${fileSize} MB)`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-outline-danger';
                    removeBtn.textContent = 'Remove';
                    removeBtn.onclick = function() {
                        // Create a new FileList without this file
                        const dt = new DataTransfer();
                        for (let j = 0; j < files.length; j++) {
                            if (j !== i) {
                                dt.items.add(files[j]);
                            }
                        }
                        pdfFileInput.files = dt.files;
                        pdfFileInput.dispatchEvent(new Event('change', { bubbles: true }));
                    };
                    
                    listItem.appendChild(fileInfo);
                    listItem.appendChild(removeBtn);
                    fileListItems.appendChild(listItem);
                }
            } else {
                fileList.style.display = 'none';
            }
        });
    }
    
    // Show loading overlay on form submit
    form.addEventListener('submit', function(e) {
        const selectedType = document.querySelector('input[name="source_type"]:checked').value;
        if (selectedType === 'pdf') {
            const files = pdfFileInput.files;
            if (files && files.length > 0) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                const statusText = document.getElementById('processingStatus');
                if (files.length > 1) {
                    statusText.textContent = `Processing ${files.length} files...`;
                } else {
                    statusText.textContent = 'Processing file...';
                }
            }
        } else {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
    });
});
</script>
{% endblock %}
