{% extends "base.html" %}

{% block title %}Create Research Brief{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/research.css') }}">
{% endblock %}

{% block content %}
<div class="research-container">
    <div class="research-header">
        <h1>Create Research Brief</h1>
        <a href="{{ url_for('research_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="research-form-card">
        <form method="POST" enctype="multipart/form-data" id="briefForm">
            {{ form.hidden_tag() }}
            
            <div class="form-section">
                <h3>Select Input Type</h3>
                <div class="form-group">
                    {{ form.source_type.label(class="form-label") }}
                    <div class="radio-group">
                        {% for subfield in form.source_type %}
                            <div class="form-check">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.source_type.errors %}
                        <div class="text-danger">
                            {% for error in form.source_type.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section" id="pdfSection" style="display: none;">
                <h3>Upload PDF</h3>
                <div class="form-group">
                    {{ form.pdf_file.label(class="form-label") }}
                    {{ form.pdf_file(class="form-control") }}
                    <small class="form-text text-muted">Maximum file size: 25 MB. Only PDF files are accepted.</small>
                    {% if form.pdf_file.errors %}
                        <div class="text-danger">
                            {% for error in form.pdf_file.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section" id="textSection">
                <h3>Enter Source Text</h3>
                <div class="form-group">
                    {{ form.source_text.label(class="form-label") }}
                    {{ form.source_text(class="form-control") }}
                    <small class="form-text text-muted">Minimum 50 characters required.</small>
                    {% if form.source_text.errors %}
                        <div class="text-danger">
                            {% for error in form.source_text.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-actions">
                {{ form.submit(class="btn btn-primary btn-lg") }}
                <a href="{{ url_for('research_list') }}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Generating research brief... This may take a moment.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceTypeRadios = document.querySelectorAll('input[name="source_type"]');
    const pdfSection = document.getElementById('pdfSection');
    const textSection = document.getElementById('textSection');
    const form = document.getElementById('briefForm');

    // Toggle sections based on source type
    function updateSections() {
        const selectedType = document.querySelector('input[name="source_type"]:checked').value;
        if (selectedType === 'pdf') {
            pdfSection.style.display = 'block';
            textSection.style.display = 'none';
            document.getElementById('source_text').required = false;
            document.getElementById('pdf_file').required = true;
        } else {
            pdfSection.style.display = 'none';
            textSection.style.display = 'block';
            document.getElementById('source_text').required = true;
            document.getElementById('pdf_file').required = false;
        }
    }

    // Add event listeners
    sourceTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateSections);
    });

    // Initial update
    updateSections();

    // Show loading overlay on form submit
    form.addEventListener('submit', function() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    });
});
</script>
{% endblock %}
