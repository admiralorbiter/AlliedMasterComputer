{% extends "base.html" %}

{% block title %}Create Research Brief{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/research.css') }}">
{% endblock %}

{% block content %}
<div class="research-container">
    <div class="research-header">
        <h1>Create Research Brief</h1>
        <a href="{{ url_for('research_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="research-form-card">
        <form method="POST" enctype="multipart/form-data" id="briefForm">
            {{ form.hidden_tag() }}
            
            <div class="form-section">
                <h3>Select Input Type</h3>
                <div class="form-group">
                    {{ form.source_type.label(class="form-label") }}
                    <div class="radio-group">
                        {% for subfield in form.source_type %}
                            <div class="form-check">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.source_type.errors %}
                        <div class="text-danger">
                            {% for error in form.source_type.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section" id="pdfSection" style="display: none;">
                <h3>Upload PDF(s)</h3>
                <div class="form-group">
                    {{ form.pdf_file.label(class="form-label") }}
                    {{ form.pdf_file(class="form-control", multiple=True) }}
                    <small class="form-text text-muted">You can select multiple PDF files. Maximum 25 MB per file, 100 MB total. Only PDF files are accepted.</small>
                    {% if form.pdf_file.errors %}
                        <div class="text-danger">
                            {% for error in form.pdf_file.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div id="fileList" class="mt-3" style="display: none;">
                        <h5>Selected Files:</h5>
                        <ul id="fileListItems" class="list-group"></ul>
                    </div>
                </div>
            </div>

            <div class="form-section" id="textSection">
                <h3>Enter Source Text</h3>
                <div class="form-group">
                    {{ form.source_text.label(class="form-label") }}
                    {{ form.source_text(class="form-control") }}
                    <small class="form-text text-muted">Minimum 50 characters required.</small>
                    {% if form.source_text.errors %}
                        <div class="text-danger">
                            {% for error in form.source_text.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section" id="manualSection" style="display: none;">
                <h3>Manual Entry</h3>
                <p class="text-muted">Paste the formatted content from ChatGPT or another source into the fields below.</p>
                
                <div class="form-group">
                    {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-control") }}
                    {% if form.title.errors %}
                        <div class="text-danger">
                            {% for error in form.title.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.citation.label(class="form-label") }}
                    {{ form.citation(class="form-control") }}
                    {% if form.citation.errors %}
                        <div class="text-danger">
                            {% for error in form.citation.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.url.label(class="form-label") }}
                    {{ form.url(class="form-control") }}
                    <small class="form-text text-muted">Enter the URL to the source article (optional, but recommended for easy access).</small>
                    {% if form.url.errors %}
                        <div class="text-danger">
                            {% for error in form.url.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="summary" class="form-label">Summary</label>
                    {{ form.summary(id="summary") }}
                    <div id="summary-editor" class="quill-editor-container"></div>
                    <small class="form-text text-muted">Use the toolbar to format your summary. Supports markdown shortcuts: # for headings, **text** for bold, - for lists.</small>
                    {% if form.summary.errors %}
                        <div class="text-danger">
                            {% for error in form.summary.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.manual_source_text.label(class="form-label") }}
                    {{ form.manual_source_text(class="form-control") }}
                    <small class="form-text text-muted">Paste the original article or source text here.</small>
                    {% if form.manual_source_text.errors %}
                        <div class="text-danger">
                            {% for error in form.manual_source_text.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.source_name.label(class="form-label") }}
                    {{ form.source_name(class="form-control") }}
                    <small class="form-text text-muted">Select the source where you formatted this brief (optional).</small>
                    {% if form.source_name.errors %}
                        <div class="text-danger">
                            {% for error in form.source_name.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section" id="aiPromptSection" style="display: none;">
                <h3>AI Prompt Helper</h3>
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-robot"></i> Copyable AI Prompt Template</span>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="copyAIPrompt()">
                            <i class="fas fa-copy"></i> Copy Prompt
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Use this prompt template with ChatGPT or another AI assistant to format an article into a structured research brief:</p>
                        <pre id="aiPromptText" class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">Please format the following article into a structured research brief with the following sections:

**Title**: A clear, concise title for the research brief

**Citation**: Full citation in standard format (e.g., Author(s). "Title." Journal/Publication, Year, Volume(Issue), Pages. DOI/URL if available)

**Summary**: A comprehensive summary organized with:
- Key Findings: (bullet points)
- Main Points: (bullet points)
- Methodology/Approach: (if applicable)
- Conclusions/Recommendations: (if applicable)

**Source Text**: The complete, unedited original article text

Please ensure:
1. The title is descriptive and captures the essence of the article
2. The citation follows standard academic or publication formatting
3. The summary uses clear bullet points and is well-organized
4. The source text is the complete, unaltered original article

Note: After formatting, you can also add the article URL in the separate URL field for easy access.

Here is the article to format:

[Paste your article text here]</pre>
                        <div id="copyFeedback" class="alert alert-success mt-2" style="display: none;">
                            <i class="fas fa-check-circle"></i> Prompt copied to clipboard!
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span><i class="fas fa-info-circle"></i> Expected Format</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text">The AI should return a response in this format:</p>
                        <pre class="bg-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word;">**Title**: [Brief title here]

**Citation**: [Full citation here]

**Summary**: 
Key Findings:
• [Key finding 1]
• [Key finding 2]

Main Points:
• [Main point 1]
• [Main point 2]

[Additional sections as needed]

**Source Text**: 
[Complete original article text here]</pre>
                        <p class="card-text mt-2"><small class="text-muted">Once you have the formatted output from the AI, paste each section into the corresponding fields above.</small></p>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Tags (Optional)</h3>
                <div class="form-group">
                    {{ form.tags.label(class="form-label") }}
                    {{ form.tags(class="form-control") }}
                    <small class="form-text text-muted">Add tags separated by commas. These tags will be applied to all uploaded briefs.</small>
                    {% if form.tags.errors %}
                        <div class="text-danger">
                            {% for error in form.tags.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                    <span id="submitText">Generate Brief</span>
                </button>
                <a href="{{ url_for('research_list') }}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Processing PDF(s)... This may take a moment.</p>
            <p class="mt-2 text-muted" id="processingStatus"></p>
        </div>
    </div>

    {% if batch_results %}
    <div class="research-form-card mt-4">
        <h3>Processing Results</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Status</th>
                        <th>Message</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in batch_results %}
                    <tr>
                        <td>{{ result.filename }}</td>
                        <td>
                            {% if result.status == 'success' %}
                                <span class="badge bg-success">Success</span>
                            {% elif result.status == 'duplicate' %}
                                <span class="badge bg-warning">Duplicate</span>
                            {% else %}
                                <span class="badge bg-danger">Error</span>
                            {% endif %}
                        </td>
                        <td>{{ result.message }}</td>
                        <td>
                            {% if result.status == 'success' and result.brief_id %}
                                <a href="{{ url_for('research_view', id=result.brief_id) }}" class="btn btn-sm btn-primary">
                                    View Brief
                                </a>
                            {% elif result.status == 'duplicate' and result.brief_id %}
                                <a href="{{ url_for('research_view', id=result.brief_id) }}" class="btn btn-sm btn-secondary">
                                    View Existing
                                </a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <a href="{{ url_for('research_create') }}" class="btn btn-primary">Upload More PDFs</a>
            <a href="{{ url_for('research_list') }}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="{{ url_for('static', filename='js/quill-config.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceTypeRadios = document.querySelectorAll('input[name="source_type"]');
    const pdfSection = document.getElementById('pdfSection');
    const textSection = document.getElementById('textSection');
    const form = document.getElementById('briefForm');

    const manualSection = document.getElementById('manualSection');
    const aiPromptSection = document.getElementById('aiPromptSection');
    const submitButton = document.getElementById('submitButton');
    const submitText = document.getElementById('submitText');

    // Copy AI prompt to clipboard
    function copyAIPrompt() {
        const promptText = document.getElementById('aiPromptText').textContent;
        navigator.clipboard.writeText(promptText).then(function() {
            const feedback = document.getElementById('copyFeedback');
            feedback.style.display = 'block';
            setTimeout(function() {
                feedback.style.display = 'none';
            }, 2000);
        }).catch(function(err) {
            console.error('Failed to copy: ', err);
            alert('Failed to copy prompt. Please manually select and copy the text.');
        });
    }
    window.copyAIPrompt = copyAIPrompt;

    // Toggle sections based on source type
    function updateSections() {
        const selectedType = document.querySelector('input[name="source_type"]:checked').value;
        
        if (selectedType === 'pdf') {
            pdfSection.style.display = 'block';
            textSection.style.display = 'none';
            manualSection.style.display = 'none';
            aiPromptSection.style.display = 'none';
            document.getElementById('source_text').required = false;
            document.getElementById('pdf_file').required = true;
            submitText.textContent = 'Generate Brief';
        } else if (selectedType === 'manual') {
            pdfSection.style.display = 'none';
            textSection.style.display = 'none';
            manualSection.style.display = 'block';
            aiPromptSection.style.display = 'block';
            document.getElementById('source_text').required = false;
            document.getElementById('pdf_file').required = false;
            submitText.textContent = 'Create Brief';
        } else {
            pdfSection.style.display = 'none';
            textSection.style.display = 'block';
            manualSection.style.display = 'none';
            aiPromptSection.style.display = 'none';
            document.getElementById('source_text').required = true;
            document.getElementById('pdf_file').required = false;
            submitText.textContent = 'Generate Brief';
        }
    }

    // Add event listeners
    sourceTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateSections);
    });

    // Initial update
    updateSections();

    // Initialize Quill editor for summary field (only in manual section)
    let summaryQuill = null;
    function initSummaryEditor() {
        const manualSection = document.getElementById('manualSection');
        if (manualSection && manualSection.style.display !== 'none') {
            const summaryEditor = document.getElementById('summary-editor');
            const summaryInput = document.getElementById('summary');
            if (summaryEditor && summaryInput && !summaryQuill) {
                const initialContent = summaryInput.value || '';
                summaryQuill = window.initQuillEditor('summary-editor', 'summary', initialContent);
            }
        }
    }

    // Update sections function - also initialize editor when manual section is shown
    const originalUpdateSections = updateSections;
    updateSections = function() {
        originalUpdateSections();
        // Initialize editor if manual section is visible
        setTimeout(function() {
            if (document.getElementById('manualSection').style.display !== 'none') {
                initSummaryEditor();
            } else if (summaryQuill) {
                // Clean up if switching away from manual
                summaryQuill = null;
            }
        }, 100);
    };

    // Initialize editor on page load if manual is selected
    setTimeout(function() {
        if (document.getElementById('manualSection').style.display !== 'none') {
            initSummaryEditor();
        }
    }, 200);

    // Handle file selection for PDF uploads
    const pdfFileInput = document.getElementById('pdf_file');
    const fileList = document.getElementById('fileList');
    const fileListItems = document.getElementById('fileListItems');
    
    if (pdfFileInput) {
        pdfFileInput.addEventListener('change', function() {
            const files = this.files;
            if (files && files.length > 0) {
                fileList.style.display = 'block';
                fileListItems.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    const fileInfo = document.createElement('span');
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    fileInfo.textContent = `${file.name} (${fileSize} MB)`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-outline-danger';
                    removeBtn.textContent = 'Remove';
                    removeBtn.onclick = function() {
                        // Create a new FileList without this file
                        const dt = new DataTransfer();
                        for (let j = 0; j < files.length; j++) {
                            if (j !== i) {
                                dt.items.add(files[j]);
                            }
                        }
                        pdfFileInput.files = dt.files;
                        pdfFileInput.dispatchEvent(new Event('change', { bubbles: true }));
                    };
                    
                    listItem.appendChild(fileInfo);
                    listItem.appendChild(removeBtn);
                    fileListItems.appendChild(listItem);
                }
            } else {
                fileList.style.display = 'none';
            }
        });
    }
    
    // Show loading overlay on form submit
    form.addEventListener('submit', function(e) {
        const selectedType = document.querySelector('input[name="source_type"]:checked').value;
        if (selectedType === 'pdf') {
            const files = pdfFileInput.files;
            if (files && files.length > 0) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                const statusText = document.getElementById('processingStatus');
                if (files.length > 1) {
                    statusText.textContent = `Processing ${files.length} files...`;
                } else {
                    statusText.textContent = 'Processing file...';
                }
            }
        } else if (selectedType === 'text') {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        // Manual entry doesn't show loading overlay (instant save)
    });
});
</script>
{% endblock %}
