{% extends "base.html" %}

{% block title %}Edit Research Brief{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/research.css') }}">
{% endblock %}

{% block content %}
<div class="research-container">
    <div class="research-header">
        <h1>Edit Research Brief</h1>
        <a href="{{ url_for('research_view', id=brief.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Brief
        </a>
    </div>

    <div class="research-form-card">
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="form-section">
                <div class="form-group">
                    {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-control") }}
                    {% if form.title.errors %}
                        <div class="text-danger">
                            {% for error in form.title.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    {{ form.citation.label(class="form-label") }}
                    {{ form.citation(class="form-control") }}
                    {% if form.citation.errors %}
                        <div class="text-danger">
                            {% for error in form.citation.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    {{ form.url.label(class="form-label") }}
                    {{ form.url(class="form-control") }}
                    <small class="form-text text-muted">Enter the URL to the source article (optional, but recommended for easy access).</small>
                    {% if form.url.errors %}
                        <div class="text-danger">
                            {% for error in form.url.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label for="summary" class="form-label">Summary</label>
                    {{ form.summary() }}
                    <div id="summary-editor" class="quill-editor-container"></div>
                    <small class="form-text text-muted">Use the toolbar to format your summary. Supports markdown shortcuts: # for headings, **text** for bold, - for lists.</small>
                    {% if form.summary.errors %}
                        <div class="text-danger">
                            {% for error in form.summary.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    {{ form.tags.label(class="form-label") }}
                    <div class="tags-input-wrapper">
                        {{ form.tags(class="form-control tags-input") }}
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Enter tags separated by commas (e.g., ai, research, machine-learning)
                        </small>
                    </div>
                    {% if form.tags.errors %}
                        <div class="text-danger">
                            {% for error in form.tags.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if brief.tags.count() > 0 %}
                        <div class="current-tags-display">
                            <strong>Current tags:</strong>
                            {% for tag in brief.tags.all() %}
                                <span class="tag-badge-display">
                                    <i class="fas fa-tag"></i> {{ tag.name }}
                                </span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-actions">
                {{ form.submit(class="btn btn-primary btn-lg") }}
                <a href="{{ url_for('research_view', id=brief.id) }}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="{{ url_for('static', filename='js/quill-config.js') }}"></script>
<script>
// Use a small delay to ensure DOM is fully ready and form fields are rendered
setTimeout(function() {
    const summaryInput = document.getElementById('summary');
    
    if (!summaryInput) {
        console.error('Summary input field not found!');
        // Try again after a short delay
        setTimeout(function() {
            const retryInput = document.getElementById('summary');
            if (!retryInput) {
                console.error('Summary input still not found after retry!');
                return;
            }
            initializeEditor(retryInput);
        }, 100);
        return;
    }
    
    initializeEditor(summaryInput);
}, 50);

function initializeEditor(summaryInput) {
    // Get the summary content from the brief object (JSON-encoded for safety)
    const summaryContentFromBrief = {{ brief.summary|tojson|safe }};
    
    // Get initial content - prioritize hidden input value, then brief content
    let initialContent = summaryInput.value || summaryInput.getAttribute('value') || '';
    
    // If hidden input is empty, use the brief content directly
    if (!initialContent && summaryContentFromBrief) {
        initialContent = summaryContentFromBrief;
        // Set it on the hidden input for form submission
        summaryInput.value = summaryContentFromBrief;
    }
    
    // Debug logging
    console.log('Summary input found:', !!summaryInput);
    console.log('Input value attribute:', summaryInput.getAttribute('value'));
    console.log('Input value property:', summaryInput.value);
    console.log('Brief content available:', !!summaryContentFromBrief);
    console.log('Initial content length:', initialContent ? initialContent.length : 0);
    if (initialContent) {
        console.log('Content preview:', initialContent.substring(0, 200));
    }
    
    // Initialize Quill editor with existing content
    const summaryQuill = window.initQuillEditor('summary-editor', 'summary', initialContent);
    
    if (!summaryQuill) {
        console.error('Failed to initialize Quill editor!');
        return;
    }
    
    // Verify content was loaded
    setTimeout(function() {
        const editorContent = summaryQuill.root.innerHTML;
        console.log('Editor content after init:', editorContent ? editorContent.substring(0, 200) : 'empty');
        if (!editorContent || editorContent === '<p><br></p>' || editorContent === '<p></p>') {
            console.warn('Editor appears empty after initialization!');
            // Try to set content again
            if (initialContent) {
                try {
                    const isHTML = /<[a-z][\s\S]*>/i.test(initialContent.trim());
                    if (isHTML) {
                        const delta = summaryQuill.clipboard.convert({ html: initialContent.trim() });
                        summaryQuill.setContents(delta);
                    } else {
                        summaryQuill.setText(initialContent);
                    }
                } catch (e) {
                    console.error('Error setting content:', e);
                }
            }
        }
    }, 100);
    
    // Ensure content is synced before form submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            if (summaryQuill) {
                const html = summaryQuill.root.innerHTML;
                if (html !== '<p><br></p>' && html !== '<p></p>') {
                    summaryInput.value = html;
                } else {
                    summaryInput.value = '';
                }
            }
        });
    }
}
</script>
{% endblock %}
